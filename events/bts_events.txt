namespace = bts

# Tradition Astral Studies adopted
country_event = {
    id = bts.10
	title = tr_astral_studies_adopt_event_name
	desc = tr_astral_studies_adopt_event_desc
	picture = GFX_evt_astral_scar
	show_sound = ap_rift_event_32_psionic_comms
	is_triggered_only = yes

	option = {
        name = OK
        hidden_effect = {
            every_system = {
                limit = {
                    OR = {
                        has_astral_rift = yes
                        any_system_planet = {
                            is_astral_scar = yes
                        }
                    }
                }
                set_surveyed = { surveyed = yes surveyor = root }
            }
        }
    }
}

# Tradition Astral Studies finished Status
country_event = {
    id = bts.11
	title = tr_astral_studies_finish_event_name
	desc = tr_astral_studies_finish_event_desc
	picture = GFX_evt_astral_rift
	show_sound = ap_rift_event_32_psionic_comms
	is_triggered_only = yes

    trigger = {
        has_country_flag = wait_spawn_astral_rift
        any_system_within_border = {
            can_spawn_astral_rift = yes
        }
    }

    immediate = {
        remove_country_flag = wait_spawn_astral_rift
        ordered_system_within_border = {
            limit = {
                can_spawn_astral_rift = yes
            }
            position = 0
            order_by = trigger:distance_to_capital
            inverse = yes
            save_event_target_as = bts_astral_studies_target_system
        }
    }

	option = {
        name = tr_astral_studies_finish_event_target_system
        hidden_effect = {
            event_target:bts_astral_studies_target_system = {
                spawn_astral_rift = {
					random_pos = yes
					orbit_angle = 360
					spawn_sound = no
				}
            }
        }
    }
}

# Trigger psionic wave pulse on enter battle
country_event = {
	id = bts.12
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		fromfrom.solar_system  = {
			exists = starbase
			starbase = {
				has_starbase_building = bts_shroud_destabilizer
			}
		}
	}
    immediate = {
		fromfrom.solar_system.starbase = {
			starbase_event = { id = bts.13 }
		}
    }
}

# Psionic wave pulse
starbase_event = {
	id = bts.13
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		fleet = {
			solar_system = {
				every_system_ambient_object = {
					limit = { has_ambient_object_flag = bts_psionic_wave_starbase_module }
					destroy_ambient_object = this
				}
			}
			if = {
				limit = { is_in_combat = yes }
				create_ambient_object = {
					type = "bts_psionic_wave"
					location = this
					play_animation_once = yes
				}
				last_created_ambient_object = {
					set_ambient_object_flag = bts_psionic_wave_starbase_module
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
				}
				root = {
					starbase_event = { id = bts.13 days = 10 }
				}
			}
		}
	}
}

# End of the cycle check 
country_event = {
	id = bts.20
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        if = {
            limit = {
                check_variable = {
                    which = end_covenant_rank
                    value > @bts_eoc_rank_to_survive
                }
            }
            country_event = { id = bts.21 } # Won End of the Cycle race
        }
        else = {
            country_event = { id = utopia.3320 } # Default End of the Cycle behavior
        }
    }
}

country_event = {
	id = bts.21
	title = end_covenant_surive_event_title
	picture = GFX_evt_unspeakable_horror
	show_sound = event_red_alert
	location = root

	is_triggered_only = yes

	desc = end_covenant_surive_event_desc

    immediate = {
        every_owned_planet = {
            limit = { has_modifier = covenant_shroud_marked }
            remove_modifier = covenant_shroud_marked
        }
        every_subject = {
            every_owned_planet = {
                limit = { has_modifier = covenant_shroud_marked } 
                remove_modifier = covenant_shroud_marked
            }
        }
    }

    option = {
        name = OK
    }

}


# End of the cycle powers
country_event = {
	id = bts.30
	title = "utopia.3000.name"
	desc = "utopia.3170.desc"
	diplomatic = yes
	diplomatic_title = BLANK_STRING
	force_open = yes

	picture_event_data = {
		portrait = shroud1
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = shroud_diplomacy_engaged
	}

	after = {
		hidden_effect = {
			remove_country_flag = shroud_diplomacy_engaged
		}
	}

    inline_script = {
        script = bts_shroud_power_option
        NAME = bts_eoc_power_summon_1
        ALLOW = "bts_can_use_power_summon_1 = yes"
        RESOURCE = sr_zro
        SHROUD_DELVE_COOLDOWN = @bts_eoc_power_summon_1_shroud_delve_cooldown
        USE_COST = @bts_eoc_power_summon_1_zro_cost
        EVENT_ID = bts.31
    }

    inline_script = {
        script = bts_shroud_power_option
        NAME = bts_eoc_power_summon_2
        ALLOW = "bts_can_use_power_summon_2 = yes"
        RESOURCE = sr_zro
        SHROUD_DELVE_COOLDOWN = @bts_eoc_power_summon_2_shroud_delve_cooldown
        USE_COST = @bts_eoc_power_summon_2_zro_cost
        EVENT_ID = bts.32
    }

    inline_script = {
        script = bts_shroud_power_option
        NAME = bts_eoc_power_summon_3
        ALLOW = "bts_can_use_power_summon_3 = yes"
        RESOURCE = sr_zro
        SHROUD_DELVE_COOLDOWN = @bts_eoc_power_summon_3_shroud_delve_cooldown
        USE_COST = @bts_eoc_power_summon_3_zro_cost
        EVENT_ID = bts.33
    }

    inline_script = {
        script = bts_shroud_power_option
        NAME = bts_eoc_power_summon_4
        ALLOW = "bts_can_use_power_summon_4 = yes custom_tooltip = { fail_text = bts_power_4_already_in_use NOT = { any_owned_ship = { is_ship_size = warped_consciousness } } }"
        RESOURCE = sr_zro
        SHROUD_DELVE_COOLDOWN = @bts_eoc_power_summon_4_shroud_delve_cooldown
        USE_COST = @bts_eoc_power_summon_4_zro_cost
        EVENT_ID = bts.34
    }

	option = {
		name = "exit.shroud"
		custom_tooltip = "exit.shroud.tooltip"
		default_hide_option = yes
	}
}


country_event = {
	id = bts.31
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        random_owned_megastructure = {
            limit = {
                bts_is_aetherophasic_collapser = yes
            }
            save_event_target_as = bts_aetherophasic_collapser_summon
        }
		create_fleet = {
			name = "NAME_Psionic_Avatar"
			settings = {
				spawn_debris = no
			}
			effect = {
				set_owner = root
				create_ship = {
					name = "NAME_Avatar"
					design = "NAME_Shroud_Avatar"
					prefix = no
					upgradable = no
				}
				set_location = event_target:bts_aetherophasic_collapser_summon
			}
		}
    }
}

country_event = {
	id = bts.32
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        random_owned_megastructure = {
            limit = {
                bts_is_aetherophasic_collapser = yes
            }
            save_event_target_as = bts_aetherophasic_collapser_summon
        }
		create_fleet = {
			name = "NAME_Corrupted_Avatar"
			settings = {
				spawn_debris = no
			}
			effect = {
				set_owner = root
				create_ship = {
					name = "NAME_Corrupted_Avatar"
					design = "NAME_Corrupted_Avatar"
				}
				set_location = event_target:bts_aetherophasic_collapser_summon
            }
		}
    }
}

country_event = {
	id = bts.33
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        random_owned_megastructure = {
            limit = {
                bts_is_aetherophasic_collapser = yes
            }
            save_event_target_as = bts_aetherophasic_collapser_summon
        }
        create_fleet = {
            name = "NAME_Shroud_Manifestation"
            settings = {
                spawn_debris = no
            }
            effect = {
                set_owner = root
                create_ship = {
                    name = "NAME_Fragment"
                    design = "NAME_Shroud_Manifestation"
                }
                set_location = event_target:bts_aetherophasic_collapser_summon
            }
        }
    }
}

country_event = {
	id = bts.34
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        random_owned_megastructure = {
            limit = {
                bts_is_aetherophasic_collapser = yes
            }
            save_event_target_as = bts_aetherophasic_collapser_summon
        }
		create_fleet = {
			name = "NAME_The_End"
			settings = {
				spawn_debris = no
			}
			effect = {
				set_owner = root
				create_ship = {
					name = "NAME_Reckoning"
					design = "NAME_Warped_Consciousness"
					effect = {
						ship_event = { id = bts.342 } # Update modifiers
					}
				}
				set_location = event_target:bts_aetherophasic_collapser_summon
			}
		}
		set_variable = {
			which = "end_pop_killed"
			value = 0
		}
    }
}


# God Ray
planet_event = {
	id = bts.340
	hide_window = yes

	is_triggered_only = yes

    trigger = {
        from = {
            any_owned_ship = {
                is_ship_size = warped_consciousness
            }
        }
    }

	immediate = {
        # Non robot planet : SUCCESS
		if = {
			limit = {
				NOT = { is_planet_class = pc_ai }
				exists = owner
				owner = { NOT = { is_same_value = from.owner } }
			}
			from.owner = {
				country_event = { id = bts.341 }
			}
		}

		# Contingency Machine World
		if = {
			limit = {
				is_planet_class = pc_ai
				NOT = { has_planet_flag = machine_lair }
			}
			set_planet_flag = destroyed_by_colossus
			set_planet_flag = planet_godrayed
			planet_event = { id = crisis.2040 }
			create_ambient_object = {
				location = this
				type = habitat_cracker_object
				duration = 5

				use_3d_location = yes
				base_angle_towards = star
				entity_face_object = star

				entity_offset = { min = 0 max = 0 }

				entity_scale_to_size = yes
				scale = 0.5
			}
		}

		# Contingency Final Machine World
		if = {
			limit = {
				is_planet_class = pc_ai
				has_planet_flag = machine_lair
			}
			set_planet_flag = destroyed_by_colossus
			set_planet_flag = planet_godrayed
			from.owner = { save_event_target_as = final_machine_world_destroyer }
			stop_crisis_sound = yes
			planet_event = { id = crisis.2046 }
			create_ambient_object = {
				location = this
				type = habitat_cracker_object
				duration = 5

				use_3d_location = yes
				base_angle_towards = star
				entity_face_object = star

				entity_offset = { min = 0 max = 0 }

				entity_scale_to_size = yes
				scale = 0.5
			}
		}

        # Robots pops
		every_owned_pop = {
			limit = {
				OR = {
					has_trait = trait_mechanical
					has_trait = trait_machine_unit
					has_trait = trait_hive_mind
					has_living_standard = { # Bio-trophies die without care
						country = root.owner
						type = living_standard_organic_trophy
					}
				}
			}
			kill_pop = yes
			from.owner = {
				if = {
					limit = { has_ascension_perk = ap_become_the_crisis }
					complete_crisis_objective = crisobj_purge_pops
				}
			}
		}

        # Organic pops
		every_owned_pop = {
			limit = {
				NOR = {
					has_trait = trait_mechanical
					has_trait = trait_machine_unit
					has_trait = trait_hive_mind
					has_living_standard = {
						country = root.owner
						type = living_standard_organic_trophy
					}
				}
			}

            from.owner = {
                change_variable = {
                    which = "end_pop_killed"
                    value = 1
                }
            }
            kill_pop = yes
            from.owner = {
				if = {
					limit = { has_ascension_perk = ap_become_the_crisis }
					complete_crisis_objective = crisobj_purge_pops
				}
			}
		}
		# Special graphics for Habitats and Ring Worlds
		if = {
			limit = {
				is_planet_class = pc_habitat
			}
			spawn_habitat_divine_effect = yes
		}
		else_if = {
			limit = {
				is_planet_class = pc_ringworld_habitable
			}
			spawn_ringworld_divine_effect = yes
		}
		if = {
			limit = {
				OR = {
					is_planet_class = pc_habitat
					is_planet_class = pc_ringworld_habitable
				}
			}
			# nothing
		}
		else = {
			change_pc = this
		}

		from = {
			random_owned_ship = {
				limit = {
					is_ship_size = warped_consciousness
				}
				ship_event = { id = bts.342 }
			}
		}
	}
}

country_event = {
	id = bts.341
	title = bts_planet_destruction_name
	desc = bts_planet_destruction_desc
	picture = GFX_evt_planet_beam
	show_sound = event_mystic_reveal
	location = from

	is_triggered_only = yes

	option = {
		name = OK
		from = {
			custom_tooltip = bts_planet_destruction_tooltip
		}
	}
}

# Updated Reckoning modifier
ship_event = {
	id = bts.342
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		remove_modifier = absorbed_consciousness_0
        remove_modifier = absorbed_consciousness_1
        remove_modifier = absorbed_consciousness_2
        remove_modifier = absorbed_consciousness_3
        remove_modifier = absorbed_consciousness_4
        remove_modifier = absorbed_consciousness_5
        if = {
        	limit = {
        		owner = {
        			check_variable = {
        				which = "end_pop_killed"
        				value < 250
        			}
        		}
        	}
        	add_modifier = {
        		modifier = "absorbed_consciousness_0"
        		days = -1
        	}
		}
		else_if = {
        	limit = {
        		owner = {
        			check_variable = {
        				which = "end_pop_killed"
        				value < 500
        			}
        		}
        	}
        	add_modifier = {
        		modifier = "absorbed_consciousness_1"
        		days = -1
        	}
        }
        else_if = {
        	limit = {
        		owner = {
        			check_variable = {
        				which = "end_pop_killed"
        				value < 1000
        			}
        		}
        	}
        	add_modifier = {
        		modifier = "absorbed_consciousness_2"
        		days = -1
        	}
        }
        else_if = {
        	limit = {
        		owner = {
        			check_variable = {
        				which = "end_pop_killed"
        				value < 2500
        			}
        		}
        	}
        	add_modifier = {
        		modifier = "absorbed_consciousness_3"
        		days = -1
        	}
        }
        else_if = {
        	limit = {
        		owner = {
        			check_variable = {
        				which = "end_pop_killed"
        				value < 5000
        			}
        		}
        	}
        	add_modifier = {
        		modifier = "absorbed_consciousness_4"
        		days = -1
        	}
        }
        else = {
        	add_modifier = {
        		modifier = "absorbed_consciousness_5"
        		days = -1
        	}
        }
    }
}