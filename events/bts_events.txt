namespace = bts

# Debug
astral_rift_event = {
	id = bts.101
	title = astral_rift.3235.name
	desc = {
		trigger = {
			switch = {
				trigger = has_astral_rift_flag
				description_gestalt = { text = astral_rift.3235.desc.gestalt }
				description_materialist = { text = astral_rift.3235.desc.materialist }
				default = { text = astral_rift.3235.desc.default }
			}
		}
	}
	picture = GFX_evt_astral_rift_psionic_stranger
	show_sound = ap_rift_event_32_psionic_comms
	difficulty = @astral_rift_easy_plus_difficulty
	astral_rift = yes
	is_triggered_only = yes

	immediate = {
		finish_astral_rift = yes
	}
}

# Tradition Astral Studies adopted
country_event = {
    id = bts.10
	title = tr_astral_studies_adopt_event_name
	desc = tr_astral_studies_adopt_event_desc
	picture = GFX_evt_astral_scar
	show_sound = ap_rift_event_32_psionic_comms
	is_triggered_only = yes

	option = {
        name = OK
        hidden_effect = {
            every_system = {
                limit = {
                    OR = {
                        has_astral_rift = yes
                        any_system_planet = {
                            is_astral_scar = yes
                        }
                    }
                }
                set_surveyed = { surveyed = yes surveyor = root }
            }
        }
    }
}

# Tradition Astral Studies finished Status
country_event = {
    id = bts.11
	title = tr_astral_studies_finish_event_name
	desc = tr_astral_studies_finish_event_desc
	picture = GFX_evt_astral_rift
	show_sound = ap_rift_event_32_psionic_comms
	is_triggered_only = yes

    trigger = {
        has_country_flag = wait_spawn_astral_rift
        any_system_within_border = {
            can_spawn_astral_rift = yes
        }
    }

    immediate = {
        remove_country_flag = wait_spawn_astral_rift
        ordered_system_within_border = {
            limit = {
                can_spawn_astral_rift = yes
            }
            position = 0
            order_by = trigger:distance_to_capital
            inverse = yes
            save_event_target_as = bts_astral_studies_target_system
        }
    }

	option = {
        name = tr_astral_studies_finish_event_target_system
        hidden_effect = {
            event_target:bts_astral_studies_target_system = {
                spawn_astral_rift = {
					random_pos = yes
					orbit_angle = 360
					spawn_sound = no
				}
            }
        }
    }
}

# End of the cycle check 
country_event = {
	id = bts.20
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        if = {
            limit = {
                check_variable = {
                    which = end_covenant_rank
                    value > @bts_eoc_rank_to_survive
                }
            }
            country_event = { id = bts.21 } # Won End of the Cycle race
        }
        else = {
            country_event = { id = utopia.3320 } # Default End of the Cycle behavior
        }
    }
}

country_event = {
	id = bts.21
	title = end_covenant_surive_event_title
	picture = GFX_evt_unspeakable_horror
	show_sound = event_red_alert
	location = root

	is_triggered_only = yes

	desc = end_covenant_surive_event_desc

    immediate = {
        every_owned_planet = {
            limit = { has_modifier = covenant_shroud_marked }
            remove_modifier = covenant_shroud_marked
        }
        every_subject = {
            every_owned_planet = {
                limit = { has_modifier = covenant_shroud_marked } 
                remove_modifier = covenant_shroud_marked
            }
        }
    }

    option = {
        name = OK
    }

}


# End of the cycle powers
country_event = {
	id = bts.30
	title = "utopia.3000.name"
	desc = "utopia.3170.desc"
	diplomatic = yes
	diplomatic_title = BLANK_STRING
	force_open = yes

	picture_event_data = {
		portrait = shroud1
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = shroud_diplomacy_engaged
	}

	after = {
		hidden_effect = {
			remove_country_flag = shroud_diplomacy_engaged
		}
	}

    inline_script = {
        script = bts_shroud_power_option
        NAME = bts_eoc_power_summon_1
        ALLOW = "bts_can_use_power_summon_1 = yes"
        RESOURCE = sr_zro
        SHROUD_DELVE_COOLDOWN = @bts_eoc_power_summon_1_shroud_delve_cooldown
        USE_COST = @bts_eoc_power_summon_1_zro_cost
        EVENT_ID = bts.31
    }

    inline_script = {
        script = bts_shroud_power_option
        NAME = bts_eoc_power_summon_2
        ALLOW = "bts_can_use_power_summon_2 = yes"
        RESOURCE = sr_zro
        SHROUD_DELVE_COOLDOWN = @bts_eoc_power_summon_2_shroud_delve_cooldown
        USE_COST = @bts_eoc_power_summon_2_zro_cost
        EVENT_ID = bts.32
    }

    inline_script = {
        script = bts_shroud_power_option
        NAME = bts_eoc_power_summon_3
        ALLOW = "bts_can_use_power_summon_3 = yes"
        RESOURCE = sr_zro
        SHROUD_DELVE_COOLDOWN = @bts_eoc_power_summon_3_shroud_delve_cooldown
        USE_COST = @bts_eoc_power_summon_3_zro_cost
        EVENT_ID = bts.33
    }

    inline_script = {
        script = bts_shroud_power_option
        NAME = bts_eoc_power_summon_4
        ALLOW = "bts_can_use_power_summon_4 = yes"
        RESOURCE = sr_zro
        SHROUD_DELVE_COOLDOWN = @bts_eoc_power_summon_4_shroud_delve_cooldown
        USE_COST = @bts_eoc_power_summon_4_zro_cost
        EVENT_ID = bts.34
    }

	option = {
		name = "exit.shroud"
		custom_tooltip = "exit.shroud.tooltip"
		default_hide_option = yes
	}
}


country_event = {
	id = bts.31
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        random_owned_megastructure = {
            limit = {
                bts_is_aetherophasic_collapser = yes
            }
            save_event_target_as = bts_aetherophasic_collapser_summon
        }
		create_fleet = {
			name = "NAME_Psionic_Avatar"
			settings = {
				spawn_debris = no
			}
			effect = {
				set_owner = root
				create_ship = {
					name = "NAME_Avatar"
					design = "NAME_Shroud_Avatar"
					prefix = no
					upgradable = no
				}
				set_location = event_target:bts_aetherophasic_collapser_summon
			}
		}
    }
}

country_event = {
	id = bts.32
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        random_owned_megastructure = {
            limit = {
                bts_is_aetherophasic_collapser = yes
            }
            save_event_target_as = bts_aetherophasic_collapser_summon
        }
		create_fleet = {
			name = "NAME_Corrupted_Avatar"
			settings = {
				spawn_debris = no
			}
			effect = {
				set_owner = root
				create_ship = {
					name = "NAME_Corrupted_Avatar"
					design = "NAME_Corrupted_Avatar"
				}
				set_location = event_target:bts_aetherophasic_collapser_summon
            }
		}
    }
}

country_event = {
	id = bts.33
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        random_owned_megastructure = {
            limit = {
                bts_is_aetherophasic_collapser = yes
            }
            save_event_target_as = bts_aetherophasic_collapser_summon
        }
        create_fleet = {
            name = "NAME_Shroud_Manifestation"
            settings = {
                spawn_debris = no
            }
            effect = {
                set_owner = root
                create_ship = {
                    name = "NAME_Fragment"
                    design = "NAME_Shroud_Manifestation"
                }
                set_location = event_target:bts_aetherophasic_collapser_summon
            }
        }
    }
}

country_event = {
	id = bts.34
    hide_window = yes
	is_triggered_only = yes

    immediate = {
        random_owned_megastructure = {
            limit = {
                bts_is_aetherophasic_collapser = yes
            }
            save_event_target_as = bts_aetherophasic_collapser_summon
        }
		create_fleet = {
			name = "NAME_The_End"
			settings = {
				spawn_debris = no
			}
			effect = {
				# save_global_event_target_as = the_end_of_the_cycle
				set_owner = root
				create_ship = {
					name = "NAME_Reckoning"
					design = "NAME_Warped_Consciousness"
				}
				set_location = event_target:bts_aetherophasic_collapser_summon
				# if = {
				# 	limit = {
				# 		root = {
				# 			check_variable = {
				# 				which = "end_power"
				# 				value < 500
				# 			}
				# 		}
				# 	}
				# 	add_modifier = {
				# 		modifier = "absorbed_consciousness_1"
				# 		days = -1
				# 	}
				# }
				# else_if = {
				# 	limit = {
				# 		root = {
				# 			check_variable = {
				# 				which = "end_power"
				# 				value < 1000
				# 			}
				# 		}
				# 	}
				# 	add_modifier = {
				# 		modifier = "absorbed_consciousness_2"
				# 		days = -1
				# 	}
				# }
				# else_if = {
				# 	limit = {
				# 		root = {
				# 			check_variable = {
				# 				which = "end_power"
				# 				value < 2500
				# 			}
				# 		}
				# 	}
				# 	add_modifier = {
				# 		modifier = "absorbed_consciousness_3"
				# 		days = -1
				# 	}
				# }
				# else_if = {
				# 	limit = {
				# 		root = {
				# 			check_variable = {
				# 				which = "end_power"
				# 				value < 5000
				# 			}
				# 		}
				# 	}
				# 	add_modifier = {
				# 		modifier = "absorbed_consciousness_4"
				# 		days = -1
				# 	}
				# }
				# else = {
				# 	add_modifier = {
				# 		modifier = "absorbed_consciousness_5"
				# 		days = -1
				# 	}
				# }
			}
		}
    }
}
