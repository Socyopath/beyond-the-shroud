namespace = utopia

@covenant_rank_1 = 20
@covenant_rank_2 = 50
@covenant_rank_3 = 90
@covenant_rank_4 = 150

# Pick a Patron to contact
country_event = {
	id = utopia.3303

	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				has_origin = origin_bts_zroni
			}
			country_event = { id = bts.20 } # BTS Covenant
		}
		else = {
			random_list = {
				25 = {	# The Whisperers in the Void
					modifier = {
						factor = 1.5
						OR = {
							has_civic = civic_cutthroat_politics
							has_civic = civic_technocracy
							is_scavenger = yes
							has_civic = civic_criminal_heritage
							has_toxic_baths = yes
							has_civic = civic_shadow_council
						}
					}
					modifier = {
						factor = 1.3
						OR = {
							has_tradition = tr_subterfuge_finish
							has_tradition = tr_discovery_finish
						}
					}
					modifier = {
						factor = 1.3
						OR = {
							has_ascension_perk = ap_enigmatic_engineering
							has_ascension_perk = ap_technological_ascendancy
						}
					}
					modifier = {
						factor = 1.3
						has_ethic = ethic_materialist
					}
					modifier = {
						factor = 1.5
						has_ethic = ethic_fanatic_materialist
					}
					modifier = {
						factor = 1.6
						any_envoy = {
							has_envoy_task = {
								task = spy_network
							}
						}
					}
					modifier = {
						factor = 0.7
						has_civic = civic_inwards_perfection
					}
					modifier = {
						factor = 0.3
						has_ethic = ethic_spiritualist
					}
					modifier = {
						factor = 0
						has_ethic = ethic_fanatic_spiritualist
						NOT = { has_country_flag = contact_whisperers }
					}
					modifier = {
						factor = 0.001
						OR = {
							has_country_flag = contact_composer
							has_country_flag = contact_eater
							has_country_flag = contact_instrument
						}
					}
					country_event = { id = utopia.3304 }
				}
				25 = {	# The Composer of Strands
					modifier = {
						factor = 1.5
						OR = {
							has_civic = civic_environmentalist
							is_catalytic_empire = yes
							has_civic = civic_idyllic_bloom
							has_toxic_baths = yes
						}
					}
					modifier = {
						factor = 1.3
						has_tradition = tr_adaptability_finish
					}
					modifier = {
						factor = 1.3
						OR = {
							has_ascension_perk = ap_consecrated_worlds
							has_ascension_perk = ap_xeno_compatibility
						}
					}
					modifier = {
						factor = 1.3
						has_ethic = ethic_xenophile
					}
					modifier = {
						factor = 1.5
						has_ethic = ethic_fanatic_xenophile
					}
					modifier = {
						factor = 1.6
						num_buildings = {
							type = building_clinic
							value = 0
						}
						num_buildings = {
							type = building_hospital
							value = 0
						}
					}
					modifier = {
						factor = 0.7
						is_relentless_industrialist_empire = yes
					}
					modifier = {
						factor = 0.3
						has_ethic = ethic_xenophobe
					}
					modifier = {
						factor = 0
						has_ethic = ethic_fanatic_xenophobe
						NOT = { has_country_flag = contact_composer }
					}
					modifier = {
						factor = 0.001
						OR = {
							has_country_flag = contact_whisperers
							has_country_flag = contact_eater
							has_country_flag = contact_instrument
						}
					}
					country_event = { id = utopia.3305 }
				}
				25 = {	# The Eater of Worlds
					modifier = {
						factor = 1.5
						OR = {
							has_civic = civic_citizen_service
							has_civic = civic_fanatic_purifiers
							has_civic = civic_distinguished_admiralty
							has_civic = civic_naval_contractors
							has_civic = civic_barbaric_despoilers
							has_civic = civic_private_military_companies
						}
					}
					modifier = {
						factor = 1.3
						has_tradition = tr_supremacy_finish
					}
					modifier = {
						factor = 1.3
						OR = {
							has_ascension_perk = ap_galactic_force_projection
							has_ascension_perk = ap_interstellar_dominion
						}
					}
					modifier = {
						factor = 1.3
						has_ethic = ethic_militarist
					}
					modifier = {
						factor = 1.5
						has_ethic = ethic_fanatic_militarist
					}
					modifier = {
						factor = 1.6
						is_at_war = yes
					}
					modifier = {
						factor = 0.7
						OR = {
							has_civic = civic_inwards_perfection
							has_civic = civic_agrarian_idyll
						}
					}
					modifier = {
						factor = 0.3
						has_ethic = ethic_pacifist
					}
					modifier = {
						factor = 0
						has_ethic = ethic_fanatic_pacifist
						NOT = { has_country_flag = contact_eater }
					}
					modifier = {
						factor = 0.001
						OR = {
							has_country_flag = contact_composer
							has_country_flag = contact_whisperers
							has_country_flag = contact_instrument
						}
					}
					country_event = { id = utopia.3306 }
				}
				25 = {	# The Instrument of Desire
					modifier = {
						factor = 1.5
						OR = {
							has_civic = civic_aristocratic_elite
							has_civic = civic_feudal_realm
							has_civic = civic_slaver_guilds
							has_civic = civic_pleasure_seekers
							has_toxic_baths = yes
							has_civic = civic_indentured_assets
							has_civic = civic_corporate_hedonism
						}
					}
					modifier = {
						factor = 1.3
						has_tradition = tr_domination_finish
					}
					modifier = {
						factor = 1.3
						OR = {
							has_ascension_perk = ap_shared_destiny
							has_ascension_perk = ap_imperial_prerogative
						}
					}
					modifier = {
						factor = 1.3
						has_ethic = ethic_authoritarian
					}
					modifier = {
						factor = 1.5
						has_ethic = ethic_fanatic_authoritarian
					}
					modifier = {
						factor = 1.6
						OR = {
							is_at_war = no
							ruler = {
								has_trait_tier1or2 = { TRAIT = leader_trait_substance_abuser }
							}
							any_owned_planet = {
								is_colony = yes
								has_designation = col_resort
							}
						}
					}
					modifier = {
						factor = 0.7
						has_civic = civic_shared_burden
					}
					modifier = {
						factor = 0.3
						has_ethic = ethic_egalitarian
					}
					modifier = {
						factor = 0
						has_ethic = ethic_fanatic_egalitarian
						NOT = { has_country_flag = contact_instrument }
					}
					modifier = {
						factor = 0.001
						OR = {
							has_country_flag = contact_composer
							has_country_flag = contact_eater
							has_country_flag = contact_whisperers
						}
					}
					country_event = { id = utopia.3307 }
				}
				2 = {
					modifier = {
						factor = 5
						any_country = {
							NOT = { is_same_value = ROOT }
							has_crisis_level = crisis_level_5 # Someone wants to destroy the galaxy? Let's give them a challenge.
						}
					}
					modifier = {
						factor = 5
						has_country_flag = knights_met_end_of_cycle
					}
					modifier = {
						factor = 0.3
						OR = {
							has_country_flag = contact_composer
							has_country_flag = contact_eater
							has_country_flag = contact_instrument
							has_country_flag = contact_whisperers
						}
					}
					if = {
						limit = {
							NOT = { has_global_flag = end_of_the_cycle }
						}
						country_event = { id = utopia.3308 } # The End of the Cycle - extremely rare
					}
					else = {
						random_list = {
							25 = { country_event = { id = utopia.3304 } }	# The Whisperers in the Void
							25 = { country_event = { id = utopia.3305 } }	# The Composer of Strands
							25 = { country_event = { id = utopia.3306 } }	# The Eater of Worlds
							25 = { country_event = { id = utopia.3307 } }	# The Instrument of Desire
						}
					}
				}
			}
		}
	}

	after = {
		remove_country_flag = contact_composer
		remove_country_flag = contact_eater
		remove_country_flag = contact_instrument
		remove_country_flag = contact_whisperers
	}
}


# A Confirmation
country_event = {
	id = utopia.2658
	title = "utopia.2658.name"
	desc = "utopia.2658.desc"
	picture = GFX_evt_shroudwalker_enclave
	show_sound = event_psionic
	trackable = yes

	is_triggered_only = yes

	option = { #Confirm Composer of Strands
		name = "utopia.2658.a"
		trigger = {
			has_modifier = covenant_composer_of_strands_0
		}
		begin_event_chain = {
			event_chain = "composer_covenant_chain"
			target = this
		}
		hidden_effect = {
			set_country_flag = composer_covenant_confirmed
			set_variable = {
				which = composer_covenant_rank
				value = 1
			}
		}
	}
	option = { #Confirm Eater of Worlds
		name = "utopia.2658.a"
		trigger = {
			has_modifier = covenant_eater_of_worlds_0
		}
		begin_event_chain = {
			event_chain = "eater_covenant_chain"
			target = this
		}
		hidden_effect = {
			set_country_flag = eater_covenant_confirmed
			country_event = { id = utopia.2660 }
			random_owned_planet = { #OM NOM NOM NOM
				limit = {
					is_capital = no
					any_owned_pop = {
						is_sapient = yes
						is_robot_pop = no
					}
				}
				random_owned_pop = {
					limit = {
						is_sapient = yes
						is_robot_pop = no
					}
					kill_pop = yes
				}
			}
			set_variable = {
				which = eater_covenant_rank
				value = 1
			}
		}
	}
	option = { #Confirm Instrument of Desire
		name = "utopia.2658.a"
		trigger = {
			has_modifier = covenant_instrument_of_desire_0
		}
		begin_event_chain = {
			event_chain = "instrument_covenant_chain"
			target = this
		}
		hidden_effect = {
			set_country_flag = instrument_covenant_confirmed
			set_variable = {
				which = instrument_covenant_rank
				value = 1
			}
		}
	}
	option = { #Confirm Whisperers in the Void
		name = "utopia.2658.a"
		trigger = {
			has_modifier = covenant_whisperers_in_the_void_0
		}
		begin_event_chain = {
			event_chain = "whisperers_covenant_chain"
			target = this
		}
		hidden_effect = {
			set_country_flag = whisperers_covenant_confirmed
			set_variable = {
				which = whisperers_covenant_rank
				value = 1
			}
		}
	}
	option = { #Confirm BTS Custom covenant
		name = "utopia.2658.a"
		trigger = {
			has_modifier = bts_covenant_modifier_0
		}
		begin_event_chain = {
			event_chain = "bts_covenant_chain"
			target = this
		}
		hidden_effect = {
			set_country_flag = bts_covenant_confirmed
			set_variable = {
				which = bts_covenant_rank
				value = 1
			}
		}
	}
	option = {
		name = "utopia.2658.b"
		hidden_effect = {
			remove_country_flag = form_covenant_flag
			remove_modifier = covenant_composer_of_strands_0
			remove_modifier = covenant_eater_of_worlds_0
			remove_modifier = covenant_instrument_of_desire_0
			remove_modifier = covenant_whisperers_in_the_void_0
			remove_modifier = covenant_whisperers_in_the_void_0_fircon
			remove_modifier = bts_covenant_modifier_0
		}
	}
}

# Covenant Sealed
country_event = {
	id = utopia.3310
	title = "utopia.3310.name"
	picture = GFX_evt_unspeakable_horror
	show_sound = event_mystic_reveal
	location = root

	is_triggered_only = yes

	desc = {
		text = covenant.whisperers.desc
		trigger = { has_modifier = covenant_whisperers_in_the_void_0 }
	}

	desc = {
		text = covenant.composer.desc
		trigger = { has_modifier = covenant_composer_of_strands_0 }
	}

	desc = {
		text = covenant.eater.desc
		trigger = { has_modifier = covenant_eater_of_worlds_0 }
	}

	desc = {
		text = covenant.instrument.desc
		trigger = { has_modifier = covenant_instrument_of_desire_0 }
	}

	desc = {
		text = covenant.cycle.desc
		trigger = { has_modifier = bts_covenant_modifier_0 }
	}

	option = {
		trigger = {
			has_modifier = covenant_whisperers_in_the_void_0
		}
		name = covenant.whisperers.option
	}
	option = {
		trigger = {
			has_modifier = covenant_instrument_of_desire_0
		}
		name = covenant.instrument.option
	}
	option = {
		trigger = {
			has_modifier = covenant_eater_of_worlds_0
		}
		name = covenant.eater.option
	}
	option = {
		trigger = {
			has_modifier = covenant_composer_of_strands_0
		}
		name = covenant.composer.option
	}
	option = {
		trigger = {
			has_modifier = bts_covenant_modifier_0
		}
		name = covenant.cycle.option
	}
}

# BTS Custom covenant
country_event = {
	id = bts.20
	title = "utopia.3000.name"
	desc = "utopia.3307.desc"
	diplomatic = yes
	diplomatic_title = BLANK_STRING
	force_open = yes

	picture_event_data = {
		portrait = shroud1
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = shroud_diplomacy_engaged
	}

	after = {
		hidden_effect = {
			remove_country_flag = shroud_diplomacy_engaged
		}
	}

	option = {
		name = "utopia.3307.a"
		trigger = {
			NOT = { has_country_flag = tradition_covenant }
		}
		custom_tooltip = "covenant.tooltip"
		add_modifier = { modifier = bts_covenant_modifier_0 days = -1 }
		begin_event_chain = {
			event_chain = "bts_covenant_chain"
			target = this
		}
		hidden_effect = {
			set_country_flag = has_shroud_patron
			set_country_flag = bts_covenant_confirmed
			country_event = { id = utopia.3310 } # Covenant Sealed
			set_variable = {
				which = bts_covenant_rank
				value = 1
			}
		}
	}
	option = { #Tradition Covenant
		name = "utopia.3307.a"
		trigger = {
			has_country_flag = tradition_covenant
		}
		custom_tooltip = "covenant.tooltip"
		add_modifier = { modifier = bts_covenant_modifier_0 days = -1 }
		hidden_effect = {
			set_country_flag = has_shroud_patron
			remove_country_flag = tradition_covenant
			country_event = { id = utopia.3310 } # Covenant Sealed
			if = {
				limit = {
					has_tradition = tr_psionics_finish
					NOT = { has_country_flag = confirmation_incoming }
				}
				country_event = { id = utopia.2658 days = 360 }
			}
		}
	}
	option = {
		name = "exit.shroud"
		custom_tooltip = "exit.shroud.tooltip"
		default_hide_option = yes
		hidden_effect = {
			remove_country_flag = form_covenant_flag
		}
	}
}

# Monthly Covenant Rank Increase
country_event = {
	id = utopia.2665
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		OR = {
			has_country_flag = composer_covenant_confirmed
			has_country_flag = eater_covenant_confirmed
			has_country_flag = instrument_covenant_confirmed
			has_country_flag = whisperers_covenant_confirmed
			has_country_flag = bts_covenant_confirmed
		}
		OR = {
			check_variable = {
				which = composer_covenant_rank
				value < 90
			}
			check_variable = {
				which = eater_covenant_rank
				value < 90
			}
			check_variable = {
				which = instrument_covenant_rank
				value < 90
			}
			check_variable = {
				which = whisperers_covenant_rank
				value < 90
			}
			check_variable = {
				which = bts_covenant_rank
				value < 90
			}
		}
	}

	immediate = {
		if = { #Composer modifiers
			limit = {
				check_variable = {
					which = composer_covenant_rank
					value > 0
				}
			}
			change_variable = {
				which = composer_covenant_rank
				value = 0.03
			}
			if = { #Civics liked
				limit = {
					OR = {
						has_civic = civic_environmentalist
						is_catalytic_empire = yes
						has_civic = civic_idyllic_bloom
						has_toxic_baths = yes
					}
				}
				change_variable = {
					which = composer_covenant_rank
					value = 0.04
				}
			}
			if = { #Civics disliked
				limit = {
					is_relentless_industrialist_empire = yes
					check_variable = {
						which = composer_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = composer_covenant_rank
					value = -0.02
				}
			}
			if = { #Ethics liked
				limit = {
					has_ethic = ethic_xenophile
				}
				change_variable = {
					which = composer_covenant_rank
					value = 0.03
				}
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_xenophile
				}
				change_variable = {
					which = composer_covenant_rank
					value = 0.07
				}
			}
			if = { #Ethics disliked
				limit = {
					has_ethic = ethic_xenophobe
					check_variable = {
						which = composer_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = composer_covenant_rank
					value = -0.02
				}
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_xenophobe
					check_variable = {
						which = composer_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = composer_covenant_rank
					value = -0.05
				}
			}
			if = { #Tradition liked
				limit = {
					has_tradition = tr_adaptability_finish
				}
				change_variable = {
					which = composer_covenant_rank
					value = 0.06
				}
			}
			if = { #Acension Perks liked
				limit = {
					OR = {
						has_ascension_perk = ap_consecrated_worlds
						has_ascension_perk = ap_xeno_compatibility
					}
				}
				change_variable = {
					which = composer_covenant_rank
					value = 0.04
				}
			}
			if = { #Other things liked
				limit = {
					num_buildings = {
						type = building_clinic
						value = 0
					}
					num_buildings = {
						type = building_hospital
						value = 0
					}
				}
				change_variable = {
					which = composer_covenant_rank
					value = 0.11
				}
			}
		}
		else_if = {		#Eater modifiers
			limit = {
				check_variable = {
					which = eater_covenant_rank
					value > 0
				}
			}
			change_variable = {
				which = eater_covenant_rank
				value = 0.03
			}
			if = { #Civics liked
				limit = {
					OR = {
						has_civic = civic_citizen_service
						has_civic = civic_fanatic_purifiers
						has_civic = civic_distinguished_admiralty
						has_civic = civic_naval_contractors
						has_civic = civic_barbaric_despoilers
						has_civic = civic_private_military_companies
					}
				}
				change_variable = {
					which = eater_covenant_rank
					value = 0.04
				}
			}
			if = { #Civics disliked
				limit = {
					OR = {
						has_civic = civic_inwards_perfection
						has_civic = civic_agrarian_idyll
					}
					check_variable = {
						which = eater_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = eater_covenant_rank
					value = -0.02
				}
			}
			if = { #Ethics liked
				limit = {
					has_ethic = ethic_militarist
				}
				change_variable = {
					which = eater_covenant_rank
					value = 0.03
				}
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_militarist
				}
				change_variable = {
					which = eater_covenant_rank
					value = 0.07
				}
			}
			if = { #Ethics disliked
				limit = {
					has_ethic = ethic_pacifist
					check_variable = {
						which = eater_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = eater_covenant_rank
					value = -0.02
				}
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_pacifist
					check_variable = {
						which = eater_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = eater_covenant_rank
					value = -0.05
				}
			}
			if = { #Tradition liked
				limit = {
					has_tradition = tr_supremacy_finish
				}
				change_variable = {
					which = eater_covenant_rank
					value = 0.06
				}
			}
			if = { #Acension Perks liked
				limit = {
					OR = {
						has_ascension_perk = ap_galactic_force_projection
						has_ascension_perk = ap_interstellar_dominion
					}
				}
				change_variable = {
					which = eater_covenant_rank
					value = 0.04
				}
			}
			if = { #Other things liked
				limit = {
					is_at_war = yes
				}
				change_variable = {
					which = eater_covenant_rank
					value = 0.11
				}
			}
		}
		else_if = {		#Instrument modifiers
			limit = {
				check_variable = {
					which = instrument_covenant_rank
					value > 0
				}
			}
			change_variable = {
				which = instrument_covenant_rank
				value = 0.03
			}
			if = { #Civics liked
				limit = {
					OR = {
						has_civic = civic_aristocratic_elite
						has_civic = civic_feudal_realm
						has_civic = civic_slaver_guilds
						has_civic = civic_pleasure_seekers
						has_toxic_baths = yes
						has_civic = civic_indentured_assets
						has_civic = civic_corporate_hedonism
					}
				}
				change_variable = {
					which = instrument_covenant_rank
					value = 0.04
				}
			}
			if = { #Civics disliked
				limit = {
					has_civic = civic_shared_burden
					check_variable = {
						which = instrument_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = instrument_covenant_rank
					value = -0.02
				}
			}
			if = { #Ethics liked
				limit = {
					has_ethic = ethic_authoritarian
				}
				change_variable = {
					which = instrument_covenant_rank
					value = 0.03
				}
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_authoritarian
				}
				change_variable = {
					which = instrument_covenant_rank
					value = 0.07
				}
			}
			if = { #Ethics disliked
				limit = {
					has_ethic = ethic_egalitarian
					check_variable = {
						which = instrument_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = instrument_covenant_rank
					value = -0.02
				}
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_egalitarian
					check_variable = {
						which = instrument_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = instrument_covenant_rank
					value = -0.05
				}
			}
			if = { #Tradition liked
				limit = {
					has_tradition = tr_domination_finish
				}
				change_variable = {
					which = instrument_covenant_rank
					value = 0.06
				}
			}
			if = { #Acension Perks liked
				limit = {
					OR = {
						has_ascension_perk = ap_shared_destiny
						has_ascension_perk = ap_imperial_prerogative
					}
				}
				change_variable = {
					which = instrument_covenant_rank
					value = 0.04
				}
			}
			if = { #Other things liked
				limit = {
					OR = {
						is_at_war = no
						ruler = {
							has_trait_tier1or2 = { TRAIT = leader_trait_substance_abuser }
						}
						any_owned_planet = {
							is_colony = yes
							has_designation = col_resort
						}
					}
				}
				change_variable = {
					which = instrument_covenant_rank
					value = 0.11
				}
			}
		}
		else_if = {		#Whisperers modifiers
			limit = {
				check_variable = {
					which = whisperers_covenant_rank
					value > 0
				}
			}
			change_variable = {
				which = whisperers_covenant_rank
				value = 0.03
			}
			if = { #Civics liked
				limit = {
					OR = {
						has_civic = civic_cutthroat_politics
						has_civic = civic_technocracy
						is_scavenger = yes
						has_civic = civic_criminal_heritage
						has_toxic_baths = yes
						has_civic = civic_shadow_council
					}
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = 0.04
				}
			}
			if = { #Civics disliked
				limit = {
					has_civic = civic_inwards_perfection
					check_variable = {
						which = whisperers_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = -0.02
				}
			}
			if = { #Ethics liked
				limit = {
					has_ethic = ethic_materialist
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = 0.03
				}
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_materialist
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = 0.07
				}
			}
			if = { #Ethics disliked
				limit = {
					has_ethic = ethic_spiritualist
					check_variable = {
						which = whisperers_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = -0.02
				}
			}
			else_if = {
				limit = {
					has_ethic = ethic_fanatic_spiritualist
					check_variable = {
						which = whisperers_covenant_rank
						value < 2
					}
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = -0.05
				}
			}
			if = { #Tradition liked
				limit = {
					OR = {
						has_tradition = tr_subterfuge_finish
						has_tradition = tr_discovery_finish
					}
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = 0.06
				}
			}
			if = { #Acension Perks liked
				limit = {
					OR = {
						has_ascension_perk = ap_enigmatic_engineering
						has_ascension_perk = ap_technological_ascendancy
					}
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = 0.04
				}
			}
			if = { #Other things liked
				limit = {
					any_envoy = {
						has_envoy_task = {
							task = spy_network
						}
					}
				}
				change_variable = {
					which = whisperers_covenant_rank
					value = 0.11
				}
			}
		}
		else_if = { 	#BTS Custom covenant modifier
			limit = {
				check_variable = {
					which = bts_covenant_rank
					value > 0
				}
			}
			change_variable = {
				which = bts_covenant_rank
				value = root.value:bts_covenant_favor_per_month
			}
		}
	}
}

# Covenant Rank 1 check
country_event = { 
	id = utopia.2670
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		NOT = {
			has_country_flag = composer_covenant_rank_1
			has_country_flag = eater_covenant_rank_1
			has_country_flag = instrument_covenant_rank_1
			has_country_flag = whisperers_covenant_rank_1
			has_country_flag = bts_covenant_rank_1
		}
		OR = {
			has_country_flag = composer_covenant_confirmed
			has_country_flag = eater_covenant_confirmed
			has_country_flag = instrument_covenant_confirmed
			has_country_flag = whisperers_covenant_confirmed
			has_country_flag = bts_covenant_confirmed
		}
		OR = {
			check_variable = {
				which = composer_covenant_rank
				value > @covenant_rank_1
			}
			check_variable = {
				which = eater_covenant_rank
				value > @covenant_rank_1
			}
			check_variable = {
				which = instrument_covenant_rank
				value > @covenant_rank_1
			}
			check_variable = {
				which = whisperers_covenant_rank
				value > @covenant_rank_1
			}
			check_variable = {
				which = bts_covenant_rank
				value > @covenant_rank_1
			}
		}
	}

	immediate = {
		if = {
			limit = {
				check_variable = {
					which = composer_covenant_rank
					value > @covenant_rank_1
				}
			}
			set_country_flag = composer_covenant_rank_1
		}
		else_if = {
			limit = {
				check_variable = {
					which = eater_covenant_rank
					value > @covenant_rank_1
				}
			}
			set_country_flag = eater_covenant_rank_1
		}
		else_if = {
			limit = {
				check_variable = {
					which = instrument_covenant_rank
					value > @covenant_rank_1
				}
			}
			set_country_flag = instrument_covenant_rank_1
		}
		else_if = {
			limit = {
				check_variable = {
					which = whisperers_covenant_rank
					value > @covenant_rank_1
				}
			}
			set_country_flag = whisperers_covenant_rank_1
		}
		else_if = {
			limit = {
				check_variable = {
					which = bts_covenant_rank
					value > @covenant_rank_1
				}
			}
			set_country_flag = bts_covenant_rank_1
		}
	}

	after = {
		country_event = { id = utopia.2671 days = 3 }
	}
}
# Covenant level 1
country_event = {
	id = utopia.2671
	title = "utopia.2671.name"
	desc = "utopia.2671.desc"
	picture = GFX_evt_shroudwalker_enclave
	show_sound = event_psionic
	trackable = yes

	is_triggered_only = yes

	option = { #Composer of Strands
		name = "utopia.2671.a"
		custom_tooltip = "utopia.2671.a.tt"
		trigger = {
			has_country_flag = composer_covenant_rank_1
		}
	}
	option = { #Eater of Worlds
		name = "utopia.2671.b"
		custom_tooltip = "utopia.2671.b.tt"
		trigger = {
			has_country_flag = eater_covenant_rank_1
		}
	}
	option = { #Instrument of Desire
		name = "utopia.2671.c"
		custom_tooltip = "utopia.2671.c.tt"
		trigger = {
			has_country_flag = instrument_covenant_rank_1
		}
	}
	option = { #Whisperers in the Void
		name = "utopia.2671.d"
		custom_tooltip = "utopia.2671.d.tt"
		trigger = {
			has_country_flag = whisperers_covenant_rank_1
		}
	}
	option = { #BTS Custom covenant
		name = "bts_covenant_rank_1"
		custom_tooltip = "bts_covenant_rank_1_desc"
		trigger = {
			has_country_flag = bts_covenant_rank_1
		}
	}
}

# Covenant Rank 2 check
country_event = { 
	id = utopia.2675
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		NOT = {
			has_country_flag = composer_covenant_rank_2
			has_country_flag = eater_covenant_rank_2
			has_country_flag = instrument_covenant_rank_2
			has_country_flag = whisperers_covenant_rank_2
			has_country_flag = bts_covenant_rank_2
		}
		OR = {
			has_country_flag = composer_covenant_confirmed
			has_country_flag = eater_covenant_confirmed
			has_country_flag = instrument_covenant_confirmed
			has_country_flag = whisperers_covenant_confirmed
			has_country_flag = bts_covenant_confirmed
		}
		OR = {
			check_variable = {
				which = composer_covenant_rank
				value > @covenant_rank_2
			}
			check_variable = {
				which = eater_covenant_rank
				value > @covenant_rank_2
			}
			check_variable = {
				which = instrument_covenant_rank
				value > @covenant_rank_2
			}
			check_variable = {
				which = whisperers_covenant_rank
				value > @covenant_rank_2
			}
			check_variable = {
				which = bts_covenant_rank
				value > @covenant_rank_2
			}
		}
	}

	immediate = {
		if = {
			limit = {
				check_variable = {
					which = composer_covenant_rank
					value > @covenant_rank_2
				}
			}
			set_country_flag = composer_covenant_rank_2
		}
		else_if = {
			limit = {
				check_variable = {
					which = eater_covenant_rank
					value > @covenant_rank_2
				}
			}
			set_country_flag = eater_covenant_rank_2
		}
		else_if = {
			limit = {
				check_variable = {
					which = instrument_covenant_rank
					value > @covenant_rank_2
				}
			}
			set_country_flag = instrument_covenant_rank_2
		}
		else_if = {
			limit = {
				check_variable = {
					which = whisperers_covenant_rank
					value > @covenant_rank_2
				}
			}
			set_country_flag = whisperers_covenant_rank_2
		}
		else_if = {
			limit = {
				check_variable = {
					which = bts_covenant_rank
					value > @covenant_rank_2
				}
			}
			set_country_flag = bts_covenant_rank_2
		}
	}

	after = {
		country_event = { id = utopia.2676 days = 3 }
	}
}
# Covenant level 2
country_event = {
	id = utopia.2676
	title = "utopia.2676.name"
	desc = "utopia.2676.desc"
	picture = GFX_evt_shroudwalker_enclave
	show_sound = event_psionic
	trackable = yes

	is_triggered_only = yes

	option = { #Composer of Strands
		name = "utopia.2676.a"
		trigger = {
			has_country_flag = composer_covenant_rank_2
		}

		add_modifier = { modifier = covenant_composer_of_strands days = -1 }
		hidden_effect = {
			remove_modifier = covenant_composer_of_strands_0
		}
	}
	option = { #Eater of Worlds
		name = "utopia.2676.b"
		trigger = {
			has_country_flag = eater_covenant_rank_2
		}
		add_modifier = { modifier = covenant_eater_of_worlds days = -1 }
		hidden_effect = {
			remove_modifier = covenant_eater_of_worlds_0
		}
	}
	option = { #Instrument of Desire
		name = "utopia.2676.c"
		trigger = {
			has_country_flag = instrument_covenant_rank_2
		}
		add_modifier = { modifier = covenant_instrument_of_desire days = -1 }
		hidden_effect = {
			remove_modifier = covenant_instrument_of_desire_0
		}

	}
	option = { #Whisperers in the Void
		name = "utopia.2676.d"
		trigger = {
			has_country_flag = whisperers_covenant_rank_2
		}
		add_modifier = { modifier = covenant_whisperers_in_the_void days = -1 }
		if = {
			limit = {
				has_first_contact_dlc = yes
			}
			add_modifier = { modifier = covenant_whisperers_in_the_void_fircon days = -1 }
		}
		hidden_effect = {
			remove_modifier = covenant_whisperers_in_the_void_0
			remove_modifier = covenant_whisperers_in_the_void_0_fircon
		}
	}
	option = { #BTS Custom covenant
		name = "bts_covenant_rank_2"
		trigger = {
			has_country_flag = bts_covenant_rank_2
		}
		add_modifier = { modifier = bts_covenant_modifier_1 days = -1 }
		hidden_effect = {
			remove_modifier = bts_covenant_modifier_0
		}
	}
}

# Covenant Rank 3 check
country_event = { 
	id = utopia.2680
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		NOT = {
			has_country_flag = composer_covenant_rank_3
			has_country_flag = eater_covenant_rank_3
			has_country_flag = instrument_covenant_rank_3
			has_country_flag = whisperers_covenant_rank_3
			has_country_flag = bts_covenant_rank_3
		}
		OR = {
			has_country_flag = composer_covenant_confirmed
			has_country_flag = eater_covenant_confirmed
			has_country_flag = instrument_covenant_confirmed
			has_country_flag = whisperers_covenant_confirmed
			has_country_flag = bts_covenant_confirmed
		}
		OR = {
			check_variable = {
				which = composer_covenant_rank
				value > @covenant_rank_3
			}
			check_variable = {
				which = eater_covenant_rank
				value > @covenant_rank_3
			}
			check_variable = {
				which = instrument_covenant_rank
				value > @covenant_rank_3
			}
			check_variable = {
				which = whisperers_covenant_rank
				value > @covenant_rank_3
			}
			check_variable = {
				which = bts_covenant_rank
				value > @covenant_rank_3
			}
		}
	}

	immediate = {
		if = {
			limit = {
				check_variable = {
					which = composer_covenant_rank
					value > @covenant_rank_3
				}
			}
			set_country_flag = composer_covenant_rank_3
		}
		else_if = {
			limit = {
				check_variable = {
					which = eater_covenant_rank
					value > @covenant_rank_3
				}
			}
			set_country_flag = eater_covenant_rank_3
		}
		else_if = {
			limit = {
				check_variable = {
					which = instrument_covenant_rank
					value > @covenant_rank_3
				}
			}
			set_country_flag = instrument_covenant_rank_3
		}
		else_if = {
			limit = {
				check_variable = {
					which = whisperers_covenant_rank
					value > @covenant_rank_3
				}
			}
			set_country_flag = whisperers_covenant_rank_3
		}
		else_if = {
			limit = {
				check_variable = {
					which = bts_covenant_rank
					value > @covenant_rank_3
				}
			}
			set_country_flag = bts_covenant_rank_3
		}
	}

	after = {
		country_event = { id = utopia.2681 days = 3 }
	}
}
# Covenant level 3 - Chosen One
country_event = {
	id = utopia.2681
	title = "utopia.2681.name"
	desc = "utopia.2681.desc"
	picture = GFX_evt_shroudwalker_enclave
	show_sound = event_psionic
	trackable = yes

	is_triggered_only = yes

	immediate = {

		# First leader option.
		random_owned_leader = {
			limit = {

				# If Ruler's class fits, pick it.
				if = {
					limit = { owner = { ruler = { suitable_for_chosen = yes } } }
					is_ruler = yes
				}

				# Else, do regular pick.
				else = {
					suitable_for_chosen = yes
				}
			}
			save_event_target_as = leader_1
		}

		# Second leader option.
		random_owned_leader = {
			limit = {
				NOT = { is_same_value = event_target:leader_1 }
				suitable_for_chosen = yes
			}
			save_event_target_as = leader_2
		}

		# Third leader option.
		random_owned_leader = {
			limit = {

				# If Chosen One exists, pick it.
				if = {
					limit = {
						owner = {
							any_owned_leader = {
								NOR = {
									is_same_value = event_target:leader_1
									is_same_value = event_target:leader_2
								}
								has_trait = leader_trait_chosen
							}
						}
					}
					has_trait = leader_trait_chosen
				}

				# Else, do regular pick.
				else = {
					NOR = {
						is_same_value = event_target:leader_1
						is_same_value = event_target:leader_2
					}
					suitable_for_chosen = yes
				}
			}
			save_event_target_as = leader_3
		}

		# Forth leader option.
		random_owned_leader = {
			limit = {
				suitable_for_chosen = yes
				NOR = {
					is_same_value = event_target:leader_1
					is_same_value = event_target:leader_2
					is_same_value = event_target:leader_3
				}
				OR = {
					AND = {
						owner = { has_country_flag = composer_covenant_rank_3 }
						leader_class = scientist
					}
					AND = {
						owner = { has_country_flag = eater_covenant_rank_3 }
						leader_class = commander
					}
					AND = {
						owner = { has_country_flag = bts_covenant_rank_3 }
						leader_class = commander
					}
					AND = {
						owner = { has_country_flag = instrument_covenant_rank_3 }
						leader_class = official
					}
					AND = {
						owner = { has_country_flag = whisperers_covenant_rank_3 }
						leader_class = scientist
					}
				}
			}
			save_event_target_as = leader_4
		}
	}

	option = { #Ruler 1
		name = "utopia.2681.a"
		trigger = {
			exists = event_target:leader_1
		}
		hidden_effect = {
			event_target:leader_1 = { save_event_target_as = chosen_leader }
			country_event = { id = utopia.2682 }
		}
	}
	option = { #Ruler 2
		name = "utopia.2681.b"
		trigger = {
			exists = event_target:leader_2
		}
		hidden_effect = {
			event_target:leader_2 = { save_event_target_as = chosen_leader }
			country_event = { id = utopia.2682 }
		}
	}
	option = { #Ruler 3
		name = "utopia.2681.c"
		trigger = {
			exists = event_target:leader_3
		}
		hidden_effect = {
			event_target:leader_3 = { save_event_target_as = chosen_leader }
			country_event = { id = utopia.2682 }
		}
	}
	option = { #Ruler 4
		name = "utopia.2681.d"
		trigger = {
			exists = event_target:leader_4
		}
		hidden_effect = {
			event_target:leader_4 = { save_event_target_as = chosen_leader }
			country_event = { id = utopia.2682 }
		}
	}
}
# Covenant level 3 - Chosen One - 2
country_event = {
	id = utopia.2682
	title = "utopia.2682.name"
	desc = "utopia.2682.desc"
	picture = GFX_evt_shroudwalker_enclave
	show_sound = event_psionic
	trackable = yes

	is_triggered_only = yes


	option = {
		name = "utopia.2682.a"
		default_hide_option = yes
		event_target:chosen_leader = {
			remove_all_negative_traits = yes

			# Composer.
			if = {
				limit = {
					ROOT = { has_country_flag = composer_covenant_rank_3 }
				}
				add_trait = leader_trait_composer_chosen
				remove_trait = leader_trait_psionic
			}

			# Eater.
			if = {
				limit = {
					ROOT = { has_country_flag = eater_covenant_rank_3 }
				}
				add_trait = leader_trait_eater_chosen
				remove_trait = leader_trait_psionic
			}

			# Instrument.
			if = {
				limit = {
					ROOT = { has_country_flag = instrument_covenant_rank_3 }
				}
				add_trait = leader_trait_instrument_chosen
				remove_trait = leader_trait_psionic
			}

			# Whisperers.
			if = {
				limit = {
					ROOT = { has_country_flag = whisperers_covenant_rank_3 }
				}
				add_trait = leader_trait_whisperers_chosen
				remove_trait = leader_trait_psionic
			}

			# BTS Custom covenant.
			if = {
				limit = {
					ROOT = { has_country_flag = bts_covenant_rank_3 }
				}
				add_trait = bts_leader_trait_covenant_chosen
				remove_trait = leader_trait_psionic
			}
		}
	}
}

# Covenant Rank 4 check
country_event = { 
	id = utopia.2685
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		NOT = {
			has_country_flag = composer_covenant_rank_4
			has_country_flag = eater_covenant_rank_4
			has_country_flag = instrument_covenant_rank_4
			has_country_flag = whisperers_covenant_rank_4
			has_country_flag = bts_covenant_rank_4
		}
		OR = {
			has_country_flag = composer_covenant_confirmed
			has_country_flag = eater_covenant_confirmed
			has_country_flag = instrument_covenant_confirmed
			has_country_flag = whisperers_covenant_confirmed
			has_country_flag = bts_covenant_confirmed
		}
		OR = {
			check_variable = {
				which = composer_covenant_rank
				value > @covenant_rank_4
			}
			check_variable = {
				which = eater_covenant_rank
				value > @covenant_rank_4
			}
			check_variable = {
				which = instrument_covenant_rank
				value > @covenant_rank_4
			}
			check_variable = {
				which = whisperers_covenant_rank
				value > @covenant_rank_4
			}
			check_variable = {
				which = bts_covenant_rank
				value > @covenant_rank_4
			}
		}
	}

	immediate = {
		if = {
			limit = {
				check_variable = {
					which = composer_covenant_rank
					value > @covenant_rank_4
				}
			}
			set_country_flag = composer_covenant_rank_4
		}
		else_if = {
			limit = {
				check_variable = {
					which = eater_covenant_rank
					value > @covenant_rank_4
				}
			}
			set_country_flag = eater_covenant_rank_4
		}
		else_if = {
			limit = {
				check_variable = {
					which = instrument_covenant_rank
					value > @covenant_rank_4
				}
			}
			set_country_flag = instrument_covenant_rank_4
		}
		else_if = {
			limit = {
				check_variable = {
					which = whisperers_covenant_rank
					value > @covenant_rank_4
				}
			}
			set_country_flag = whisperers_covenant_rank_4
		}
		else_if = {
			limit = {
				check_variable = {
					which = bts_covenant_rank
					value > @covenant_rank_4
				}
			}
			set_country_flag = bts_covenant_rank_4
		}
	}

	after = {
		country_event = { id = utopia.2686 days = 3 }
	}
}
# Covenant level 4
country_event = {
	id = utopia.2686
	title = "utopia.2686.name"
	desc = "utopia.2686.desc"
	picture = GFX_evt_shroudwalker_enclave
	show_sound = event_psionic
	trackable = yes

	is_triggered_only = yes

	option = { #Composer of Strands
		name = "utopia.2686.a"
		trigger = {
			has_country_flag = composer_covenant_rank_4
		}
		give_technology = {
			tech = tech_covenant_composer
			message = yes
		}
	}
	option = { #Eater of Worlds
		name = "utopia.2686.b"
		trigger = {
			has_country_flag = eater_covenant_rank_4
		}
		give_technology = {
			tech = tech_covenant_eater
			message = yes
		}
	}
	option = { #Instrument of Desire
		name = "utopia.2686.c"
		trigger = {
			has_country_flag = instrument_covenant_rank_4
		}
		give_technology = {
			tech = tech_covenant_instrument
			message = yes
		}
	}
	option = { #Whisperers in the Void
		name = "utopia.2686.d"
		trigger = {
			has_country_flag = whisperers_covenant_rank_4
		}
		give_technology = {
			tech = tech_covenant_whisperers
			message = yes
		}
	}
	option = { #BTS Custom covenant
		name = "bts_covenant_rank_4"
		trigger = {
			has_country_flag = bts_covenant_rank_4
		}
		give_technology = {
			tech = bts_tech_covenant_mark
			message = yes
		}
	}
}