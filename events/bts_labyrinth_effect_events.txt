namespace = bts


# Megastructure Info event
country_event = { 
	id = bts.300
	title = "bts.300.title"
	desc = "bts.300.desc"
	picture = GFX_evt_surreal_visions
	show_sound = event_mystic_reveal
	location = root
	is_triggered_only = yes

	trigger = {
		NOT = { has_country_flag = bts_labyrinth_of_abstraction_unlocked }
		OR = {
			has_country_flag = has_ever_established_covenant
			has_country_flag = forging_our_own_path
		}
	}

	option = {
		name = "bts.300.ok"
		custom_tooltip = "bts.300.ok.desc"
		hidden_effect = {
			set_country_flag = bts_labyrinth_of_abstraction_unlocked
		}
	}
}

# The Shroud Lobby
# FROM = Labyrinth of abstraction
country_event = {
	id = bts.301
	title = "utopia.3000.name"
	desc = {
		text = utopia.3000.intro.desc
		trigger = { has_country_flag = shroud_intro }
	}
	desc = {
		text = utopia.3000.1.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.2.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.3.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.4.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.5.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.6.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.7.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.8.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.9.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.10.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.11.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.12.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.13.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.14.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.15.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.16.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.17.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.18.desc
		trigger = { normal_shroud_message = yes }
	}
	desc = {
		text = utopia.3000.19.desc
		trigger = { normal_shroud_message = yes }
	}

	diplomatic_title = BLANK_STRING
	diplomatic = yes
	force_open = yes

	picture_event_data = {
		portrait = shroud1
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = shroud_diplomacy_engaged
	}

	after = {
		hidden_effect = {
			remove_country_flag = shroud_diplomacy_engaged
		}
	}

	inline_script = {
		script = labyrinth/bts_labyrinth_shroud_interraction
		NAME = bts.301.boon.low
		TRIGGER = bts_can_use_labyrinth_shroud_inter_choose_boon_low
		COST = @bts_labyrinth_shroud_interraction_boon_cost
		COOLDOWN = @bts_labyrinth_shroud_interraction_boon_cooldown
		COOLDOWN_FLAG = bts_labyrinth_shroud_interraction_boon
		EVENT_ID = bts.310
	}
	
	inline_script = {
		script = labyrinth/bts_labyrinth_shroud_interraction
		NAME = bts.301.boon.medium
		TRIGGER = bts_can_use_labyrinth_shroud_inter_choose_boon_medium
		COST = @bts_labyrinth_shroud_interraction_boon_cost
		COOLDOWN = @bts_labyrinth_shroud_interraction_boon_cooldown
		COOLDOWN_FLAG = bts_labyrinth_shroud_interraction_boon
		EVENT_ID = bts.311
	}

	inline_script = {
		script = labyrinth/bts_labyrinth_shroud_interraction
		NAME = bts.301.boon.high
		TRIGGER = bts_can_use_labyrinth_shroud_inter_choose_boon_high
		COST = @bts_labyrinth_shroud_interraction_boon_cost
		COOLDOWN = @bts_labyrinth_shroud_interraction_boon_cooldown
		COOLDOWN_FLAG = bts_labyrinth_shroud_interraction_boon
		EVENT_ID = bts.312
	}

	option = { # Summon Abstract Entities
		name = bts.301.powers
		trigger = {
			# bts_has_labyrinth_of_abstraction_level = { LEVEL = @bts_labyrinth_shroud_inter_powers_unlock_level }
			# bts_has_any_covenant_favor = { FAVOR_AMOUNT = @bts_labyrinth_shroud_inter_powers_favor_cost }
		}
		hidden_effect = {
			country_event = { 
				id =  bts.400 
				scopes = { 
					from = from
				} 
			}
		}
	}

	# Reset shroud delve cd
	inline_script = {
		script = labyrinth/bts_labyrinth_shroud_interraction_tooltip
		NAME = bts.301.reset
		TOOLTIP = bts.301.reset.tt
		TRIGGER = bts_can_use_labyrinth_shroud_inter_reset_cd
		COST = @bts_labyrinth_shroud_interraction_reset_cost
		COOLDOWN = @bts_labyrinth_shroud_interraction_reset_cooldown
		COOLDOWN_FLAG = bts_labyrinth_shroud_interraction_reset
		EVENT_ID = bts.313
	}


	# Change psionic aura
	inline_script = {
		script = labyrinth/bts_labyrinth_shroud_interraction_tooltip
		NAME = bts.301.aura
		TOOLTIP = bts.301.aura.tt
		TRIGGER = bts_can_use_labyrinth_shroud_inter_change_aura
		COST = @bts_labyrinth_shroud_interraction_aura_cost
		COOLDOWN = @bts_labyrinth_shroud_interraction_aura_cooldown
		COOLDOWN_FLAG = bts_labyrinth_shroud_interraction_aura
		EVENT_ID = bts.314
	}

	inline_script = {
		script = bts_conceptual_effect
		CONCEPT = time
	}

	inline_script = {
		script = bts_conceptual_effect
		CONCEPT = space
	}

	inline_script = {
		script = bts_conceptual_effect
		CONCEPT = energy
	}

	option = {
		name = "exit.shroud"
		custom_tooltip = "exit.shroud.tooltip"
		default_hide_option = yes
	}
}

# Shroud Boon Low
country_event = {
	id = bts.310
	title = "utopia.3000.name"
	desc = { text = utopia.3200.1.desc }
	desc = { text = utopia.3200.2.desc }
	desc = { text = utopia.3200.3.desc }
	desc = { text = utopia.3200.4.desc }
	desc = { text = utopia.3200.5.desc }
	desc = { text = utopia.3200.6.desc }
	desc = { text = utopia.3200.7.desc }
	desc = { text = utopia.3200.8.desc }
	desc = { text = utopia.3200.9.desc }

	diplomatic = yes
	diplomatic_title = BLANK_STRING
	force_open = yes

	picture_event_data = {
		portrait = shroud1
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = shroud_diplomacy_engaged
	}

	inline_script = {
		script = bts_shroud_boon_choices
		CHANCE = low
	}

	option = {
		name = "exit.shroud"
		custom_tooltip = "exit.shroud.tooltip"
		default_hide_option = yes
	}

	after = {
		hidden_effect = {
			remove_country_flag = shroud_diplomacy_engaged
		}
	}
}

# Shroud Boon Medium
country_event = {
	id = bts.311
	title = "utopia.3000.name"
	desc = { text = utopia.3200.1.desc }
	desc = { text = utopia.3200.2.desc }
	desc = { text = utopia.3200.3.desc }
	desc = { text = utopia.3200.4.desc }
	desc = { text = utopia.3200.5.desc }
	desc = { text = utopia.3200.6.desc }
	desc = { text = utopia.3200.7.desc }
	desc = { text = utopia.3200.8.desc }
	desc = { text = utopia.3200.9.desc }

	diplomatic = yes
	diplomatic_title = BLANK_STRING
	force_open = yes

	picture_event_data = {
		portrait = shroud1
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = shroud_diplomacy_engaged
	}

	inline_script = {
		script = bts_shroud_boon_choices
		CHANCE = medium
	}

	option = {
		name = "exit.shroud"
		custom_tooltip = "exit.shroud.tooltip"
		default_hide_option = yes
	}

	after = {
		hidden_effect = {
			remove_country_flag = shroud_diplomacy_engaged
		}
	}
}

# Shroud Boon High
country_event = {
	id = bts.312
	title = "utopia.3000.name"
	desc = { text = utopia.3200.1.desc }
	desc = { text = utopia.3200.2.desc }
	desc = { text = utopia.3200.3.desc }
	desc = { text = utopia.3200.4.desc }
	desc = { text = utopia.3200.5.desc }
	desc = { text = utopia.3200.6.desc }
	desc = { text = utopia.3200.7.desc }
	desc = { text = utopia.3200.8.desc }
	desc = { text = utopia.3200.9.desc }

	diplomatic = yes
	diplomatic_title = BLANK_STRING
	force_open = yes

	picture_event_data = {
		portrait = shroud1
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = shroud_diplomacy_engaged
	}

	inline_script = {
		script = bts_shroud_boon_choices
		CHANCE = high
	}

	option = {
		name = "exit.shroud"
		custom_tooltip = "exit.shroud.tooltip"
		default_hide_option = yes
	}

	after = {
		hidden_effect = {
			remove_country_flag = shroud_diplomacy_engaged
		}
	}
}

# Reduce Shroud Delve cooldown
country_event = {
	id = bts.313
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		add_modifier = { modifier = reduce_next_delve_cooldown }
	}
}

# Aura Mastery
country_event = {
	id = bts.314
	title = "utopia.3000.name"
	desc = { text = utopia.3200.1.desc }
	desc = { text = utopia.3200.2.desc }
	desc = { text = utopia.3200.3.desc }
	desc = { text = utopia.3200.4.desc }
	desc = { text = utopia.3200.5.desc }
	desc = { text = utopia.3200.6.desc }
	desc = { text = utopia.3200.7.desc }
	desc = { text = utopia.3200.8.desc }
	desc = { text = utopia.3200.9.desc }

	diplomatic = yes
	diplomatic_title = BLANK_STRING
	force_open = yes

	picture_event_data = {
		portrait = shroud1
		room = shroud_room
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = shroud_diplomacy_engaged
	}

	option = {
		name = bts.314.eater
		trigger = {
			has_patron_relation = { patron = the_eater_of_worlds }
		}
		custom_tooltip_with_params = {
			description = bts.314.eater.tt
			description_parameters = {
				"ATTUNEMENT" = @bts_labyrinth_shroud_interraction_aura_value
			}
		}
		bts_set_patron_attunement_exact = { PATRON = the_eater_of_worlds VALUE = @bts_labyrinth_shroud_interraction_aura_value }
	}
	option = {
		name = bts.314.cradle
		trigger = {
			has_patron_relation = { patron = the_cradle_of_souls }
		}
		custom_tooltip_with_params = {
			description = bts.314.cradle.tt
			description_parameters = {
				"ATTUNEMENT" = @bts_labyrinth_shroud_interraction_aura_value
			}
		}
		bts_set_patron_attunement_exact = { PATRON = the_cradle_of_souls VALUE = @bts_labyrinth_shroud_interraction_aura_value }
	}
	option = {
		name = bts.314.composer
		trigger = {
			has_patron_relation = { patron = the_composer_of_strands }
		}
		custom_tooltip_with_params = {
			description = bts.314.composer.tt
			description_parameters = {
				"ATTUNEMENT" = @bts_labyrinth_shroud_interraction_aura_value
			}
		}
		bts_set_patron_attunement_exact = { PATRON = the_composer_of_strands VALUE = @bts_labyrinth_shroud_interraction_aura_value }
	}
	option = {
		name = bts.314.instrument
		trigger = {
			has_patron_relation = { patron = the_instrument_of_desire }
		}
		custom_tooltip_with_params = {
			description = bts.314.instrument.tt
			description_parameters = {
				"ATTUNEMENT" = @bts_labyrinth_shroud_interraction_aura_value
			}
		}
		bts_set_patron_attunement_exact = { PATRON = the_instrument_of_desire VALUE = @bts_labyrinth_shroud_interraction_aura_value }
	}
	option = {
		name = bts.314.whisperers
		trigger = {
			has_patron_relation = { patron = whisperers_in_the_void }
		}
		custom_tooltip_with_params = {
			description = bts.314.whisperers.tt
			description_parameters = {
				"ATTUNEMENT" = @bts_labyrinth_shroud_interraction_aura_value
			}
		}
		bts_set_patron_attunement_exact = { PATRON = whisperers_in_the_void VALUE = @bts_labyrinth_shroud_interraction_aura_value }
	}
	option = {
		name = bts.314.patron
		trigger = {
			has_patron_relation = { patron = bts_patron }
		}
		custom_tooltip_with_params = {
			description = bts.314.patron.tt
			description_parameters = {
				"ATTUNEMENT" = @bts_labyrinth_shroud_interraction_aura_value
			}
		}
		bts_set_patron_attunement_exact = { PATRON = bts_patron VALUE = @bts_labyrinth_shroud_interraction_aura_value }
	}

	after = {
		hidden_effect = {
			remove_country_flag = shroud_diplomacy_engaged
		}
	}
}

# Captial Upgrade - Gives relic
planet_event = {
	id = bts.330
	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_planet_class = pc_bts_labyrinth_of_abstraction
		exists = owner
		owner = {
			bts_has_labyrinth_of_abstraction_level = {
				LEVEL = @bts_labyrinth_of_abstraction_relic_level
			}
		}
	}

	immediate = {
		owner = { add_relic = r_bts_relic_shroud_nexus } 
	}
}

# Spawn temporary shroud portal to every fleets
country_event = {
	id = bts.331
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		every_system = {
			limit = {
				any_ship_in_system = {
					is_owned_by = root
					is_ship_class = shipclass_military
				}
			}
			random_ship_in_system = {
				limit = {
					is_owned_by = root
					is_ship_class = shipclass_military
				}
				save_event_target_as = bts_temp_shroud_portal_target
			}

			spawn_megastructure = {
				type = bts_shroud_portal_megastructure
				owner = root
				coords_from = event_target:bts_temp_shroud_portal_target
				orbit_angle = 0
				orbit_distance = 0
				init_effect = {
					set_megastructure_flag = bts_shroud_portal_megastructure_temp_of@root
				}
			}
		}
		country_event = {
			id = bts.332
			days = @bts_shroud_portal_expiration_days
		}
	}
}

# Remove all temporary shroud portals
country_event = {
	id = bts.332
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		every_megastructure = {
			limit = { 
				has_megastructure_flag = bts_shroud_portal_megastructure_temp_of@root
			}
			remove_megastructure = this
		}
	}
}


# Unlock Summon District - Warning
country_event = { 
	id = bts.340
	title = "bts.340.name"
	desc = "bts.340.desc"
	picture = GFX_evt_psionic_battle
	show_sound = event_psionic

	is_triggered_only = yes

	trigger = {
		NOR = {
			has_country_flag = bts_labyrinth_summon_district_unlocked
			has_country_flag = bts_labyrinth_summon_district_event_pending
		}
		any_owned_planet = {
			is_planet_class = pc_bts_labyrinth_of_abstraction
			check_variable_arithmetic = {
				which = value:bts_labyrinth_total_jobs_for_summon_event
				value >= @bts_labyrinth_summon_district_event_job_count
			}
		}
	}

	option = {
		name = bts.340.yes

		hidden_effect = {
			set_country_flag = bts_labyrinth_summon_district_event_pending
		}
		
		country_event = {
			id = bts.341
			days = @bts_labyrinth_summon_district_event_spawn_delay_max
			random = @bts_labyrinth_summon_district_event_spawn_delay_min
		}
	}
	option = {
		name = bts.340.no
		random_owned_planet = {
			limit = { is_planet_class = pc_bts_labyrinth_of_abstraction }
			add_modifier = {
				modifier = bts_summon_event_stabilize
				days = @bts_labyrinth_summon_district_event_delay
			}
		}

		hidden_effect = {
			set_timed_country_flag = { 
				flag = bts_labyrinth_summon_district_event_pending
				days = @bts_labyrinth_summon_district_event_delay
			}
		}
	}
}

# Unlock Summon District - Summon Abstract Entity
country_event = { 
	id = bts.341
	title = "bts.341.name"
	desc = "bts.341.desc"
	picture = GFX_evt_psionics
	show_sound = event_psionic

	is_triggered_only = yes

	trigger = {
		bts_has_labyrinth_of_abstraction = yes
	}
	immediate = {
		random_owned_planet = {
			limit = { is_planet_class = pc_bts_labyrinth_of_abstraction }
			save_event_target_as = bts_abstract_entity_location
		}

		if = {
			limit = { NOT = { exists = event_target:shroud_country } }
			create_country = {
				name = "NAME_Creatures_of_the_Shroud"
				type = shroud_spirits
				flag = {
					icon = {
						category = "special"
						file = "the_shroud.dds"
					}
					background= {
						category = "backgrounds"
						file = "00_solid.dds"
					}
					colors={
						"dark_purple"
						"black"
						"null"
						"null"
					}
				}
			}
			last_created_country = {
				establish_communications_no_message = root
				save_global_event_target_as = shroud_country
			}
		}

		create_fleet = {
			name = bts_abstract_anomaly
			settings = { spawn_debris = no }
			effect = {
				set_owner = event_target:shroud_country
				create_ship = {
					name = bts_abstract_anomaly
					design = "bts_abstract_entity_1"
					effect = {
						set_ship_flag = bts_labyrinth_abstract_entity
						set_ship_flag = bts_abstract_entity_summoned_by_@root
					}
				}
				set_fleet_stance = aggressive
				set_aggro_range_measure_from = return_point
				set_aggro_range = 300
				set_location = event_target:bts_abstract_entity_location
			}
		}

		last_created_fleet = { # Despawn if enough time passes without being destroyed
			fleet_event = { id = bts.342 days = @bts_labyrinth_summon_district_event_delay_despawn }
		}
	}

	option = {
		name = bts.341.ok
	}
}

# Unlock Summon District - Kill remaining entity
fleet_event = {
	id = bts.342
	hide_window = yes

	is_triggered_only = yes

	immediate = {
		from = {
			country_event = { id = bts.343 }
		}
		destroy_fleet = this
	}
}

# Unlock Summon District - Restart process on fail
country_event = {
	id = bts.343
	title = "bts.343.name"
	desc = "bts.343.desc"
	picture = GFX_evt_psionics
	show_sound = event_psionic

	is_triggered_only = yes

	option = {
		name = bts.343.ok
		hidden_effect = {
			remove_country_flag = bts_labyrinth_summon_district_event_pending
			set_timed_country_flag = { 
				flag = bts_labyrinth_summon_district_event_pending
				days = @bts_labyrinth_summon_district_event_delay
			}
		}
	}
}

# Unlock Summon District - Abstract Entity Killed Check
country_event = { 
	id = bts.344
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		fromfromfrom = {
			has_ship_flag = bts_labyrinth_abstract_entity
		}
	}

	immediate = {
		print_scope_effect = yes
		if = {
			limit = { 
				fromfromfrom = {
					has_ship_flag = bts_abstract_entity_summoned_by_@root
				}
			}
			country_event = { id = bts.345 }
		}
		else = {
			random_country = {
				limit = {
					fromfromfrom = {
						has_ship_flag = bts_abstract_entity_summoned_by_@prev
					}
				}
				country_event = { id = bts.343 }
			}
		}
	}


}

# Unlock Summon District - Abstract Entity Killed Start Project
country_event = { 
	id = bts.345
	title = "bts.345.name"
	desc = "bts.345.desc"
	picture = GFX_evt_surreal_visions
	show_sound = event_psionic

	is_triggered_only = yes

	trigger = {
		NOT = {
			has_country_flag = bts_labyrinth_summon_district_unlocked
		}
	}

	option = {
		name = bts.345.ok
		# Start special project
		random_owned_planet = {
			limit = { is_planet_class = pc_bts_labyrinth_of_abstraction }
			enable_special_project = {
				name = "BTS_LABYRINTH_UNLOCK_SUMMON_DISTRICT_PROJECT"
				owner = root
			}
		}
	}
}

# Unlock Summon District - Project Finished
country_event = { 
	id = bts.346
	title = "bts.346.name"
	desc = "bts.346.desc"
	show_sound = event_psionic
	picture = GFX_evt_bts_summon_project
	is_triggered_only = yes

	immediate = {
		set_country_flag = bts_labyrinth_summon_district_unlocked
		remove_country_flag = bts_labyrinth_summon_district_event_pending
	}

	option = {
		name = bts.346.ok
	}
}