namespace = bts

# bts.50X -> Crisis Global Events
# bts.51X -> Crisis Lvl 1 Events
# bts.52X -> Crisis Lvl 2 Events
# bts.53X -> Crisis Lvl 3 Events
# bts.54X -> Crisis Lvl 4 Events
# bts.55X -> Crisis Lvl 5 Events

# DEBUG : Gives Devoured Mind Pop
country_event = {
	id = bts.5000
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		capital_scope = {
			create_pop = {
				species = root
			}
			last_created_pop = {
				bts_effect_devour_mind = {
					CASTER = root
				}
			}
		}
	}
}

# DEBUG : Steal a pop
country_event = {
	id = bts.5001
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		random_country = {
			limit = {
				NOT = {
					is_same_value = root
				}
				any_owned_pop = {
					is_robot_pop = no
				}
			}
			random_owned_pop = {
				limit = {
					is_robot_pop = no
					NOT = { 
						has_trait = bts_trait_crisis_thrall
					}
				}
				bts_effect_devour_mind = {
					CASTER = root
				}
				resettle_pop = {
					pop = this
					planet = root.capital_scope
				}
			}
		}
	}
}

# DEBUG : Gives crisis currency
country_event = {
	id = bts.5002
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		complete_crisis_objective = bts_crisis_obj_debug
	}
}

# DEBUG : Establish communication with elder gods
country_event = {
	id = bts.5003
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		if = {
			limit = {
				NOT = {
					exists = event_target:bts_elder_gods_country
				}
			}
			### SPAWN SPECIAL COUNTRIES
			create_country = {
				name = bts_elder_gods_country_name
				type = bts_elder_gods
				flag = {
					icon = {
						category = "special"
						file = "the_shroud.dds"
					}
					background= {
						category = "backgrounds"
						file = "00_solid.dds"
					}
					colors={
						"red"
						"black"
						"null"
						"null"
					}
				}
				effect = {
					save_global_event_target_as = bts_elder_gods_country
				}
			}
		}

		establish_communications_no_message = event_target:bts_elder_gods_country
	}
}

# Ritual: Mindset Shift
country_event = {
	id = bts.502
	picture = GFX_evt_alien_abduction
	title = bts_ritual_reset_leader
	desc = bts_ritual_reset_leader_effects

	is_triggered_only = yes

	immediate = {
		bts_event_target_list_clear = yes
		every_owned_leader = {
			limit = {
				has_skill > 1
			}
			bts_event_target_list_save = yes
		}
	}

	inline_script = {
		script = bts_option_list_hidden
		ACTION = "leader_event = { id = bts.503 }"
	}

	option = {
		name = OK
		default_hide_option = yes
	}
}

leader_event = {
	id = bts.503
	picture = GFX_evt_alien_abduction
	title = bts_ritual_reset_leader
	desc = bts_ritual_reset_leader_choose_spec

	is_triggered_only = yes

	option = {
		name = official_with_icon
		hidden_effect = {
			bts_reset_leader = { CLASS = official }
		}
	} 
	
	option = {
		name = commander_with_icon
		hidden_effect = {
			bts_reset_leader = { CLASS = commander }
		}
	}

	option = {
		name = scientist_with_icon
		hidden_effect = {
			bts_reset_leader = { CLASS = scientist }
		}
	}
}

# Create Game Country
country_event = {
	id = bts.504
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		create_country = {
			name = "NAME_Creatures_of_the_Shroud"
			type = shroud_spirits
			flag = {
				icon = {
					category = "special"
					file = "the_shroud.dds"
				}
				background= {
					category = "backgrounds"
					file = "00_solid.dds"
				}
				colors={
					"dark_purple"
					"black"
					"null"
					"null"
				}
			}
		}
		last_created_country = {
			establish_communications_no_message = root
			save_global_event_target_as = bts_shroud_rift_creatures
		}
	}
}

# Kill a fleet
fleet_event = {
	id = bts.505
	hide_window = yes

	is_triggered_only = yes

	immediate = {
		destroy_fleet = this
	}
}

# this = operation; from = target (country)
espionage_operation_event = {
	id = bts.513
	title = operation_bts_crisis_devour_mind_event_title
	desc = operation_bts_crisis_devour_mind_event_desc

	picture = GFX_evt_alien_abduction
	show_sound = event_espionage_concluded
	espionage_operation = yes
	is_triggered_only = yes

	trigger = {
		exists = from
	}

	option = {
		name = OK

		from = {
			random_owned_pop = {
				limit = {
					is_robot_pop = no
					NOT = { 
						has_trait = bts_trait_crisis_thrall
					}
				}
				custom_tooltip = operation_bts_crisis_devour_mind_tooltip_effect
				hidden_effect = {
					bts_effect_devour_mind = {
						CASTER = root.owner
					}
					resettle_pop = {
						pop = this
						planet = root.owner.capital_scope
					}
				}
				
			}
		}

		if = {
			limit = {
				owner = {
					bts_can_use_councilor_power = { COUNCILOR = bts_crisis_councilor_operation }
				}
			}
			from = {
				random_owned_pop = {
					limit = {
						is_robot_pop = no
						NOT = { 
							has_trait = bts_trait_crisis_thrall
						}
					}
					custom_tooltip = operation_bts_crisis_devour_mind_tooltip_effect
					hidden_effect = {
						bts_effect_devour_mind = {
							CASTER = root.owner
						}
						resettle_pop = {
							pop = this
							planet = root.owner.capital_scope
						}
					}
				}
			}
		}
		
	}

	after = {
		spynetwork = {
			add_spy_network_level_on_success_effect = { VALUE = -5 }
		}
		destroy_espionage_operation = this
	}
}

# Devour Mind species rights
country_event = {
	id = bts.523
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_owned_species = {
			has_citizenship_type = {
				type = citizenship_bts_crisis
				country = root
			}
		}
	}

	immediate = {
		random_list = {
			1 = { # 3 pops
				while = {
					count = 3
					random_owned_pop = {
						limit = {
							has_citizenship_type = {
								type = citizenship_bts_crisis
								country = root
							}
						}
						bts_effect_devour_mind = { 
							CASTER = root
						}
					}
				}
			}

			1 = { # 6 pops
				while = {
					count = 6
					random_owned_pop = {
						limit = {
							has_citizenship_type = {
								type = citizenship_bts_crisis
								country = root
							}
						}
						bts_effect_devour_mind = { 
							CASTER = root
						}
					}
				}
			}

			1 = { # 12 pops
				while = {
					count = 12
					random_owned_pop = {
						limit = {
							has_citizenship_type = {
								type = citizenship_bts_crisis
								country = root
							}
						}
						bts_effect_devour_mind = { 
							CASTER = root
						}
					}
				}
			}
		}
	}
}

# country_event = {
# 	id = bts.30
# 	is_triggered_only = yes
# 	hide_window = yes
	
# 	immediate = {
country_event = {
	id = bts.5400
	title = bts.5400.name
	desc = bts.5400.desc

	is_triggered_only = yes
	diplomatic = yes
	custom_gui = "bts_elder_gods_window"
	custom_gui_option = "bts_elder_gods_option"
	picture_event_data = {
		room = no_video_feed_room
	}

	option = {
		name = bts.5400.option
		default_hide_option = yes
	}
}

# This = target country (player)
# From = source country
country_event = {
	id = bts.540
	title = "bts.540.name"
	desc = bts.540.desc
	is_triggered_only = yes

	force_open = yes
	diplomatic = yes
	custom_gui = "bts_elder_gods_window"
	custom_gui_option = "bts_elder_gods_option"
	picture_event_data = {
		portrait = par_renown_15
		room = shroud_room
	}

	trigger = {
		from = { is_country_type = bts_elder_gods }
		NOT = { has_country_flag = bts_elder_gods_diplomacy_engaged } 
	}

	immediate = {
		set_country_flag = bts_elder_gods_diplomacy_engaged
	}

	after = {
		hidden_effect = {
			remove_country_flag = bts_elder_gods_diplomacy_engaged
		}
	}

	option = {
		name =  bts.540.option.1
		is_dialog_only = yes
		response_text = bts.540.resp.1
	}

	option = {
		name =  bts.540.option.2
		is_dialog_only = yes
		response_text = bts.540.resp.2
	}

	option = {
		name =  bts.540.option.3
		is_dialog_only = yes
		response_text = bts.540.resp.3
	}

	option = {
		name = bts.540.option.4
		custom_tooltip = bts.540.option.4.desc
		allow = {
			NOT = {
				has_modifier = bts_crisis_pact_cooldown
			}
			if = {
				limit = { bts_can_use_councilor_ultimate_power = { COUNCILOR = bts_crisis_councilor_pact } }
				custom_tooltip = {
					fail_text = bts_crisis_pact_only_2
					check_variable = {
						which = bts_crisis_pact_count
						value < 2
					}
				}
			}
			else = {
				custom_tooltip = {
					fail_text = bts_crisis_pact_only_1
					check_variable = {
						which = bts_crisis_pact_count
						value < 1
					}
				}
			}
		}
		add_modifier = {
			modifier = bts_crisis_pact_cooldown
			days = @bts_crisis_pact_cooldown
			time_multiplier = value:scripted_modifier_mult|MODIFIER|bts_crisis_pact_cooldown_mult|
		}
		hidden_effect = {
			random_list = {
				1 = {
					modifier = {
						factor = 0
						has_modifier = bts_crisis_pact_1
					}
					country_event = { id = bts.541 days = 1 }
				}
				1 = {
					modifier = {
						factor = 0
						has_modifier = bts_crisis_pact_2
					}
					country_event = { id = bts.542 days = 1 }
				}
				1 = {
					modifier = {
						factor = 0
						has_modifier = bts_crisis_pact_3
					}
					country_event = { id = bts.543 days = 1 }
				}
				1 = {
					modifier = {
						factor = 0
						has_modifier = bts_crisis_pact_4
					}
					country_event = { id = bts.544 days = 1 }
				}
				1 = {
					modifier = {
						factor = 0
						has_modifier = bts_crisis_pact_5
					}
					country_event = { id = bts.545 days = 1 }
				}
			}
		}
	}

	option = {
		trigger = {
			has_modifier = bts_crisis_pact_2
		}
		name = bts.5422.menu.option.title
		custom_tooltip = bts.5422.menu.option.desc
		hidden_effect = {
			country_event = {
				id = bts.5422
			}
		}
	}
	option = {
		name = EXIT
		default_hide_option = yes
	}
}

# Elder God 1 : Ghatanothoa
inline_script = {
    script = bts_crisis_pact_event_end
    EVENT_ID = bts.541
    ROOM = bts_gods_1_room
    PACT = bts_crisis_pact_1
	EVENT_NO_COST_ID = bts.5411
    EVENT_END_ID = bts.5412
}
country_event = {
	id = bts.5411
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_owned_starbase = {
			fleet = {
				add_modifier = {
					modifier = bts_crisis_pact_1_stabase_debuff_no_cost
					days = @bts_crisis_pact_1_stabase_debuff_no_cost_duration
				}
			}
		}
	}
}
country_event = {
	id = bts.5412
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_owned_starbase = {
			limit = {
				fleet = {
					has_modifier =  bts_crisis_pact_1_stabase_debuff_no_cost	
				}
			}
			fleet = {
				remove_modifier = bts_crisis_pact_1_stabase_debuff_no_cost
			}
		}
		every_system_within_border = {
			every_ship_in_system = {
				limit = {
					has_modifier =  bts_crisis_pact_1_ship_debuff	
				}
				remove_modifier = bts_crisis_pact_1_ship_debuff
			}
		}
	}
}
ship_event = {
	id = bts.5413
	hide_window = yes
	is_triggered_only = yes
	trigger {
		OR = {
			AND = { # System owner hasn't pact and ship has debuff
				has_modifier = bts_crisis_pact_1_ship_debuff
				OR = {
					NOT = { exists = from.owner }
					from.owner = {
						NOT = { has_modifier = bts_crisis_pact_1 }
					}
				}
			}

			AND = { # System owner has pact and ship has no debuff
				NOT = { has_modifier = bts_crisis_pact_1_ship_debuff } 
				exists = from.owner
				from.owner = {
					NOT = { is_same_value = root.owner }
					has_modifier = bts_crisis_pact_1
				}
			}
			
		}
	}
	immediate = {
		if = {
			limit = {
				has_modifier = bts_crisis_pact_1_ship_debuff
			}
			remove_modifier = bts_crisis_pact_1_ship_debuff
		}
		else = {
			add_modifier = {
				modifier = bts_crisis_pact_1_ship_debuff
				days = -1
			}
		}
	}
}

# Elder God 2 : Hastur
inline_script = {
    script = bts_crisis_pact_event
    EVENT_ID = bts.542
    ROOM = bts_gods_2_room
    PACT = bts_crisis_pact_2
	EVENT_NO_COST_ID = bts.5421
}
country_event = {
	id = bts.5421
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_playable_country = {
			limit = {
				NOT = { is_same_value = root }
			}
			add_opinion_modifier = { modifier = opinion_bts_crisis_pact_fail who = root }
		}
	}
}
country_event = {
	id = bts.5422
	title = bts.542.name
	desc = bts.542.desc
	is_triggered_only = yes

	force_open = yes
	diplomatic = yes
	show_sound = event_screams
	custom_gui = "bts_elder_gods_window"
	custom_gui_option = "bts_elder_gods_option"
	picture_event_data = {
		room = bts_gods_2_room
	}

	option = {
		name = bts.5422.menu.boon
		custom_tooltip = bts.5422.menu.boon.tooltip
		allow = {
			custom_tooltip = {
				fail_text = bts.5422.menu.boon.cooldown
				NOT = { has_country_flag = bts_crisis_pact_2_boon_cooldown }
			}
		}
		hidden_effect = {
			country_event = { id = bts.5423 }
		}
	}

	option = {
		name = bts.5422.menu.curse
		custom_tooltip = bts.5422.menu.curse.tooltip
		allow = {
			custom_tooltip = {
				fail_text = bts.5422.menu.curse.cooldown
				NOT = { has_country_flag = bts_crisis_pact_2_curse_cooldown }
			}
		}
		hidden_effect = {
			country_event = { id = bts.5424 }
		}
	}

	option = {
		name = EXIT
		default_hide_option = yes
	}
}
country_event = {
	id = bts.5423
	title = bts.542.name
	desc = bts.542.desc
	is_triggered_only = yes

	force_open = yes
	diplomatic = yes
	show_sound = event_screams
	custom_gui = "bts_elder_gods_window"
	custom_gui_option = "bts_elder_gods_option"
	picture_event_data = {
		room = bts_gods_2_room
	}
	immediate = {
		bts_event_target_list_clear = yes
		every_playable_country = {
			bts_event_target_list_save = yes
		}
	}
	inline_script = {
		script = bts_option_list_hidden
		ACTION = "every_playable_country = { limit = { NOT = { is_same_value = root } } add_opinion_modifier = { modifier = opinion_bts_crisis_pact_good who = prev } }"
	}

	after = {
		set_saved_date = {
			key = bts_crisis_pact_2_boon_cooldown
			days_from_present = @bts_crisis_pact_2_boon_cooldown
			expires = @bts_crisis_pact_2_boon_cooldown
		}
	}
}
country_event = {
	id = bts.5424
	title = bts.542.name
	desc = bts.542.desc
	is_triggered_only = yes

	force_open = yes
	diplomatic = yes
	show_sound = event_screams
	custom_gui = "bts_elder_gods_window"
	custom_gui_option = "bts_elder_gods_option"
	picture_event_data = {
		room = bts_gods_2_room
	}
	immediate = {
		bts_event_target_list_clear = yes
		every_playable_country = {
			bts_event_target_list_save = yes
		}
	}
	inline_script = {
		script = bts_option_list_hidden
		ACTION = "every_playable_country = { limit = { NOT = { is_same_value = root } } add_opinion_modifier = { modifier = opinion_bts_crisis_pact_bad who = prev } }"
	}

	after = {
		set_saved_date = {
			key = bts_crisis_pact_2_curse_cooldown
			days_from_present = @bts_crisis_pact_2_curse_cooldown
			expires = @bts_crisis_pact_2_curse_cooldown
		}
	}
}

# Elder God 3 : Yig
inline_script = {
    script = bts_crisis_pact_event_all
    EVENT_ID = bts.543
    ROOM = bts_gods_3_room
    PACT = bts_crisis_pact_3
	EVENT_NO_COST_ID = bts.5431
    EVENT_START_ID = bts.5432
    EVENT_END_ID = bts.5433
	
}
country_event = {
	id = bts.5431
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_owned_planet = {
			limit = {
				habitable_planet_not_urban = yes
			}
			if = {
				limit = {
					is_dry = yes
				}
				random_list = {
					1 = {
						add_deposit = d_deep_sinkhole

					}
					1 = {
						add_deposit = d_quicksand_basin
					}
					1 = {
						add_deposit = d_active_volcano
					}
					1 = {
						add_deposit = d_mountain_range
					}
					1 = {
						add_deposit = d_dangerous_wildlife_blocker
					}
				}
			}
			else_if = {
				limit = {
					is_wet = yes
				}
				random_list = {
					1 = {
						add_deposit = d_dense_jungle
					}
					1 = {
						add_deposit = d_toxic_kelp
					}
					1 = {
						add_deposit = d_active_volcano
					}
					1 = {
						add_deposit = d_mountain_range
					}
					1 = {
						add_deposit = d_dangerous_wildlife_blocker
					}
				}
			}
			else_if = {
				limit = {
					is_cold = yes
				}
				random_list = {
					1 = {
						add_deposit = d_noxious_swamp
					}
					1 = {
						add_deposit = d_massive_glacier
					}
					1 = {
						add_deposit = d_active_volcano
					}
					1 = {
						add_deposit = d_mountain_range
					}
					1 = {
						add_deposit = d_dangerous_wildlife_blocker
					}
				}
			}
			else = {
				add_deposit = d_dense_jungle
			}
		}	
	}
}
country_event = {
	id = bts.5432
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_modifier = bts_crisis_pact_3
	}

	immediate = {
		every_owned_planet = {
			limit = {
				habitable_planet_not_urban = yes
				NOT = { has_modifier = bts_crisis_pact_3_natural_worlds }
			}
			if = {
				limit = { is_planet_class = pc_gaia }
				add_modifier = {
					modifier = bts_crisis_pact_3_natural_worlds
					multiplier = 2
					days = -1
				}
			}
			else = {
				add_modifier = {
					modifier = bts_crisis_pact_3_natural_worlds
					days = -1
				}
			}
		}
	}
}
country_event = {
	id = bts.5433
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_planet_within_border = {
			limit = {
				has_modifier = bts_crisis_pact_3_natural_worlds
			}
			remove_modifier = bts_crisis_pact_3_natural_worlds
		}
	}
}

# Elder God 4 : Dagon
inline_script = {
    script = bts_crisis_pact_event_end
    EVENT_ID = bts.544
    ROOM = bts_gods_4_room
    PACT = bts_crisis_pact_4
	EVENT_NO_COST_ID = bts.5441
	EVENT_END_ID = bts.5442
}
country_event = {
	id = bts.5441
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		# Destroy random building on ocean worlds
	}
}
country_event = {
	id = bts.5442
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		# Kill all leviathans
	}
}

# Elder God 5 : Cthulhu
inline_script = {
    script = bts_crisis_pact_event_all
    EVENT_ID = bts.545
    ROOM = bts_gods_5_room
    PACT = bts_crisis_pact_5
	EVENT_NO_COST_ID = bts.5451
	EVENT_START_ID = bts.5452
	EVENT_END_ID = bts.5453
}
country_event = {
	id = bts.5451
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		# Apply devastation on colonies
	}
}
country_event = {
	id = bts.5452
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		# Spawn deamweaver fleet (start and on death after 1 year)
	}
}
country_event = {
	id = bts.5453
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		# Destroy dreamweaver
	}
}
country_event = {
	id = bts.5454
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		# Monthly add devastation to planet in the fleet system
	}
}


