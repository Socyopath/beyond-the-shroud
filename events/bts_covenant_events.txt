namespace = bts

country_event = {
	id = bts.200
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		NOT = { has_country_flag = bts_covenant_contact }
		NOT = { has_country_flag = bts_covenant_contact_pending }
		has_patron_relation = { patron = whisperers_in_the_void contact = completed }
	}

	immediate = {
		set_country_flag = bts_covenant_contact_pending
		country_event = {
			id = bts.201
			days = 10
		}
	}

}

country_event = {
	id = bts.201
	is_triggered_only = yes
	
	trigger = {
		has_country_flag = bts_covenant_contact_pending
	}

	option = {
		name = OK

		hidden_effect = {
			revert_accords = whisperers_in_the_void
			remove_country_flag = knowledge_accord
			remove_country_flag = wisdom_accord
			replace_patron = {
				new_patron = bts_patron
				replaced_patron = whisperers_in_the_void
			}
			set_patron_first_contact_state = { patron = bts_patron state = completed }
			set_attunement = {
				patron = bts_patron
				value = @attunement_first_accord
			}
			refresh_psionic_aura_type = yes
			# if = {
			# 	limit = { is_corporeal_authority = yes }
			# 	set_psionic_choir_policy = yes
			# }
			every_owned_planet = { 
				limit = { has_building = building_whisperers_sanctum } 
				remove_building = building_whisperers_sanctum
			}
			set_country_flag = bts_covenant_contact
			remove_country_flag = bts_covenant_contact_pending
		}

	}
}

# Covenant Proposal
inline_script = {
	script = shroud/patron_covenant_proposition_event
	EVENT_ID = bts.205
	FORMED_EVENT_ID = bts.206
	CONFIRM_EVENT_ID = bts.207
	PATRON_TYPE = bts_patron
	CHAIN = "shroud_bts_patron_covenant_chain"
}

# Covenant Formed
inline_script = {
	script = shroud/patron_covenant_formed_event
	EVENT_ID = bts.206
	PICTURE = GFX_evt_shroud_whisperers_in_the_void
	SOUND = event_whisperers_in_the_void
}

# Covenant Confirmation
inline_script = {
	script = shroud/patron_covenant_confirmation_event
	EVENT_ID = bts.207
	PATRON_TYPE = bts_patron
	MARK_TECH = bts_tech_covenant_mark
	TECH_PATRON = bts_patron
	CHAIN = "shroud_bts_patron_covenant_chain"
}


# Monthly attunement modifier: Whisperers in the Void
country_event = {
	id = bts.208
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		check_modifier_value = {
			modifier = bts_patron_monthly_attunement_add
			value != 0
		}
	}

	immediate = {
		add_attunement = {
			bts_patron = modifier:bts_patron_monthly_attunement_add
		}
	}
}

# Patron - Paragon Disciple
country_event = {
	id = bts.209
	title = bts.209.name
	desc = bts.209.desc
	show_sound = {
		trigger = { is_robot_empire = yes }
		sound = event_psionic_robot
	}
	show_sound = {
		trigger = { is_robot_empire = no }
		sound = event_psionic
	}
	is_triggered_only = yes

	picture = GFX_leader_recruitment_bg_renowned

	event_window_type = leader_recruit
	auto_opens = yes

	immediate = {
		shroud_leader_creator = {
			LEADER_PORTRAIT = psionic_02
			SPECIES_CLASS = FUN
			CLASS = scientist
			NAME = bts_patron_disciple
			LEVEL = 8
			AGE = 38
			GENDER = indeterminable
			ETHIC = xenophile
			DESC = bts_patron_disciple_desc
			CATCH_PHRASE = bts_patron_disciple_catch_phrase
		}
		last_created_leader = {
			add_trait = { trait = leader_trait_disciple_of_the_bts_patron consume_selection = yes }
			add_trait = { trait = leader_trait_psionic consume_selection = yes }
			add_trait = { trait = leader_trait_rift_warped consume_selection = yes }
			add_trait = { trait = leader_trait_expertise_psionics_2 consume_selection = yes }
			add_trait = { trait = leader_trait_academic_astral_rift_expert consume_selection = yes }
			add_trait = { trait = subclass_scientist_scholar consume_selection = yes }
			add_trait = { trait = leader_trait_spark_of_genius_2 consume_selection = yes }
		}
	}

	picture_event_data = {
		portrait = event_target:shroud_leader
		room = shroud_room
	}

	option = {
		name = DISMISS
		tag = dismiss_leader
		hidden_effect = {
			remove_global_flag = bts_patron_leader_found
			event_target:shroud_leader = {
				kill_leader = { show_notification = no }
			}
		}
	}
	option = {
		name = bts.209.a
		response_text = bts.209.a.response
		is_dialog_only = yes
	}
	option = {
		name = bts.209.b
		response_text = bts.209.b.response
		is_dialog_only = yes
	}
	option = {
		name = bts.209.c
		response_text = bts.209.c.response
		is_dialog_only = yes
	}
	option = {
		name = HIRE
		tag = hire_leader
		custom_tooltip = bts.209.hire_custom_tooltip
		hidden_effect = {
			shroud_leader_hire_effect = {
				GLOBAL_EVENT_TARGET = bts_patron_disciple_target
			}
		}
	}
}

# Power 2 Event 
country_event = {
	id = bts.210
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		every_system_with_aura = {
			every_neighbor_system = {
				remove_hyperlane = { from = prev to = this }
				system_event = { 
					id = bts.211
					days = 50
					scopes = { from = prev }
				}
			}
			add_aura_intensity = @accord_aura_intensity_loss
		}
	}
}

system_event = {
	id = bts.211
	is_triggered_only = yes
	hide_window = yes

	trigger = {
		FROM = {
			NOT = { has_hyperlane_to = root }
		}
	}

	immediate = {
		add_hyperlane = { 
			from = FROM 
			to = root 
		}
	}
}

# Callings
# Build or upgrade astral siphon
planet_event = {
	id = bts.220
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		exists = owner
		owner = {
			can_access_shroud = yes
		}
		OR = {
			last_building_changed = building_astral_siphon_1
			last_building_changed = building_astral_siphon_2
			last_building_changed = building_astral_siphon_3
		}
		
	}

	immediate = {
		owner = {
            add_patron_objective_counter = {
                counter = po_bts_astral_siphon
                amount = 1
            }
        }
	}

}

# Use astral action
country_event = {
	id = bts.221
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		can_access_shroud = yes
	}

	immediate = {
		add_patron_objective_counter = {
			counter = po_bts_astral_action
			amount = 1
		}
	}
}

# Explore astral rift
country_event = {
	id = bts.222
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		can_access_shroud = yes
	}

	immediate = {
		add_patron_objective_counter = {
			counter = po_bts_astral_rift
			amount = 1
		}
	}
}

# Build Hyper Relay
country_event = {
	id = bts.223
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		can_access_shroud = yes
		from = {
			OR = {
				is_megastructure_type = hyper_relay
                is_megastructure_type = hyper_relay_restored
			}
		}
	}

	immediate = {
		add_patron_objective_counter = {
			counter = po_bts_hyper_relay
			amount = 1
		}
	}
}

# Deeds
country_event = {
	id = bts.230
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		can_access_shroud = yes
	}

	immediate = {
		add_patron_objective_counter = {
			counter = po_bts_rift_stage
			amount = 1
		}
	}
}

fleet_event = {
	id = bts.231
	is_triggered_only = yes
	hide_window = yes

	trigger = {
		exists = owner
		owner = {
			can_access_shroud = yes
		}
	}

	immediate = {
		owner = {
			add_patron_objective_counter = {
				counter = po_bts_travel_bypass
				amount = 1
			}
		}
	}
}

ship_event = {
	id = bts.232
	is_triggered_only = yes
	hide_window = yes

	trigger = {
		exists = owner
		owner = {
			can_access_shroud = yes
		}
	}

	immediate = {
		owner = {
			add_patron_objective_counter = {
				counter = po_bts_jump_drive
				amount = 1
			}
		}
	}
}

country_event = {
	id = bts.233
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		can_access_shroud = yes
		category_last_picked_tradition = tradition_astral_studies
	}

	immediate = {
		add_patron_objective_counter = {
			counter = po_bts_tradition_astral
			amount = 1
		}
	}
}